[dialog5("Character Sheet", "width=750; height=700; temporary=0; input=1; noframe=0"), code: {
    <head>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" type="text/css" href="style.css@lib:front"></link>
        [r:scriptTag("open")][r:importScript("script.js@lib:front")][r:scriptTag("close")]
        [r:scriptTag("open")][r:importScript("components.js@lib:front")][r:scriptTag("close")]
        [r:'
    
        <style>
            #character-tab-left {
                position:absolute;
                width:33%;
                height:98%;
                left:0;
                top:1%;
    
                overflow-y:inherit
            }
            #character-tab-center {
                position:absolute;
                width:34%;
                height:100.5%;
                bottom: -0.5vh;
    
                background-color:#2d2d2d; 
                border: 0.2vh solid #444;
                border-bottom: none;
    
                overflow-y:inherit;
            }
            #character-tab-right {
                position:absolute;
                width:33%;
                height:98%;
                right:0;
                top:1%;
    
                overflow-y:inherit;
            }
            #portrait {
                height:15vh; 
                border-radius: 50%; 
                border: 0.3vh solid #444;
            }

            .collapsible-content {
                margin:0vh 0.67vh;
            }

            hr {
                border: 0.1vh solid #444;
                display:block;
                width: 100%;
                margin:auto;
                margin-top: 2vh;
                margin-bottom: 0;
            }

            #character-tab-right .table-header {
                margin-bottom: -1.5vh;
            }
            #character-tab-left .container {
                padding-top:0vh;
                padding-bottom: 2vh;
            }

            #ability-scores-container-content > .table-container {
                margin-right:-1.5vh;
                margin-left:-1.5vh;
            }
        </style>
    
        <script>

            function subtitle({content}) {
                return paragraph({
                    content, 
                    style:"opacity:0.8;font-weight:bold;font-size:110%;margin-bottom:-1.5vh"
                })
            }

            function title_value({title, value, id}) {
                /* return paragraph({style:"text-align:left;font-size:100%",content:(
                    span({style:"font-weight:bold", content:title}) + ": " + span({content:value})
                )}) */
               return div({style:"height:2vh;margin-bottom:1vh;position:relative;",content:(
                    paragraph({id:id+"-title", style:"position:absolute;left:1vh;text-align:left;font-weight:bold",content:title}) +
                    paragraph({id, style:"position:absolute;right:1vh;text-align:left", content:value})
               )})
            }

            function updateLeft() {

                function bonusOf(number, parenthesis=false) {
                    number = Number(number) > 0 ? "+"+number : number
                    number = parenthesis ? "("+number+")" : number

                    return number
                }
                
                toBackend(`
                    var character = impersonated();
                    JSON.stringify({
                        "attr_bonus":character.attr_bonus,
                        "skills":character.skills
                    })
                `,(response) => {
                    character = JSON.parse(response)

                    // Verify if there is update
                    const new_hash = hash(response)
                    const old_hash = getId("character-tab-left").getAttribute("hash")
                    if (new_hash == old_hash) { return }
                    getId("character-tab-left").setAttribute("hash", new_hash)

                    

                    // Attribute Bonuses and Saving Throws
                    getId("saving-throws-content").innerHTML = ""
                    const scores_list = [
                        "strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"
                    ]
                    for (const score of scores_list) {
                        title = capitalize(score)
                        value = bonusOf(character.attr_bonus[score])
                        getId("saving-throws-content").innerHTML += title_value({title, value})
                    }

                    // Skills
                    getId("skills-content").innerHTML = ""
                    for (const skill in character.skills) {
                        title = skill
                        value = bonusOf(character.skills[skill])
                        getId("skills-content").innerHTML += title_value({title, value})
                    }

                })
            }    
            function updateCenter() {
                toBackend(`
                    var character = impersonated();
                    JSON.stringify({
                        "name":character.name,
                        "portrait":character.portrait,
                        "attributes":character.attributes,
                        "type":character.type,
                        "race":character.race,
                        "health":character.health,
                        "max_health":character.max_health,
                        "armor_class":character.armor_class,
                        "initiative":character.iniative,
                        "speed":character.speed,
                        "passive_perception":character.passive_perception
                    })
                `,(response) => {
                    character = JSON.parse(response)

                    // Verify if there is update
                    const new_hash = hash(response)
                    const old_hash = getId("character-tab-center").getAttribute("hash")
                    if (new_hash == old_hash) { return }
                    getId("character-tab-center").setAttribute("hash", new_hash)

                    
                    // Basic
                    getId("name").innerHTML = character.name
                    getId("portrait").src = character.portrait
                    getId("class").innerHTML = "None"

                    // Ability Scores
                    getId("ability-scores").outerHTML = table({
                            id:"ability-scores", 
                            headers:[
                                character.attributes.strength,
                                character.attributes.dexterity, 
                                character.attributes.constitution, 
                                character.attributes.wisdom, 
                                character.attributes.intelligence, 
                                character.attributes.charisma
                            ],
                            config:"1fr 1fr 1fr 1fr 1fr 1fr",
                            header_style:"text-align:center;font-size:130%"
                        })

                    // Info
                    getId("type").innerHTML = character.type || "None"
                    getId("race").innerHTML = character.race || "None"
                    getId("health").innerHTML = character.health + " / " + character.max_health || "0 / 0"
                    getId("armor-class").innerHTML = character.armor_class || 0
                    getId("initiative").innerHTML = character.initiative || 0
                    getId("walking-speed").innerHTML = character.speed + "ft"
                    getId("passive-perception").innerHTML = character.passive_perception || 8
                    getId("level").innerHTML = character.level || 1
                    getId("experience").innerHTML = character.experience || 0 + " / 300"
                })
            }
            function updateRight() {
                toBackend(`
                    var character = impersonated();
                    [
                        JSON.stringify({
                            "conditions":character.conditions,
                            "features":character.features,
                            "proficiencies":character.proficiencies,
                            "resistances":character.resistances,
                        }),

                        JSON.stringify({
                            "conditions":database.conditions,
                            "features":database.features,
                            "proficiencies":database.proficiencies,
                            "damage_types":database.damage_types
                        })
                    ]
                `,(response) => {
                    response = JSON.parse(response)

                    character = JSON.parse(response[0])
                    database = JSON.parse(response[1])

                    // Verify if there is update
                    const new_hash = hash(JSON.stringify(response))
                    const old_hash = getId("character-tab-right").getAttribute("hash")
                    if (new_hash == old_hash) { return }
                    getId("character-tab-right").setAttribute("hash", new_hash)

                    function updateConditions() { 
                        let rows = ""
                        for (const name in character.conditions) {
                            const duration = timeUnit(character.conditions[name])
                            const condition = database.conditions.data[name]

                            let description = condition ? condition.description : "Description unavailable."

                            rows += row({
                                columns:[
                                    name, duration
                                ], 
                                config:"1fr 1fr",
                                content: pre({content:description})
                            })
                        }
                        getId("character-conditions").children[1].innerHTML = rows
                        if (rows) {
                            getId("character-conditions-container").setAttribute("style", "")
                        } else {
                            getId("character-conditions-container").setAttribute("style", "display:none")
                        }
                    }

                    function updateFeatures() {
                        const subtypeImages = {
                            "barbarian":"asset://d963c8b40a27e349e6239dcc3a1cbce2",
                            "bard":"asset://17a9f3a727fb50c75bff76d4e8ed6d27",
                            "cleric":"asset://039a32067cd1c26bf1e18c423a218f5c",
                            "druid":"asset://f03485d26b9728b00fc54c9e4e4b5b4c",
                            "fighter":"asset://0775774cade2e68e4a9c4bd5c83ea282",
                                "Battle Master":"asset://e44045582f8f31922e6c0bd793b10077",
                                "Champion":"asset://1e718dbea4b8624c664fd346724216d6",
                                "Eldritch Knight":"asset://d616194e11b05843b3553697ae268e05",
                            "monk":"asset://8047e1c0694233eb11d5a0f669e61a54",
                            "paladin":"asset://f3fcf46aaf9c1a13e33f40c62a91f541",
                            "ranger":"asset://90baa66f12545c72476e0cfd3050620f",
                            "rogue":"asset://e105c25e25210a5e107d49ef0af2bfb5",
                            "sorcerer":"asset://57460f85630f7d84602ff9128eccfef4",
                            "warlock":"asset://9663e79e3e5c493352a92ca0ba6acc60",
                            "wizard":"asset://feb415509eb88654c71b1fa53d0879f1",
                        };
                        const typeImages = {
                            "racial": "asset://3432c572c31826e72dedd81ef4a10c5b",
                            "feat": "asset://fc6c201b48e30ba2d9da845a14f92e60",
                            "class": "asset://65479d57a2b1ffc116a12a5c731d91a7"
                        };
                        
                        let rows = ""
                        for (const name of character.features.all) {
                            const feature = database.features.data[name]
                            if(feature) {
                                const description = feature.description
                                const type = feature.subtype || feature.type
                                const image_src = subtypeImages[type] || typeImages[type]

                                rows += row({
                                    columns:[
                                        image({src:image_src, style:"height:2vh"}),
                                        name,
                                        capitalize(type),
                                    ], 
                                    config:"min-content 1fr min-content",
                                    content: pre({content:description})
                                })
                            }  else {
                                rows += row({
                                    columns:[
                                        "",
                                        name,
                                        "",
                                    ], 
                                    config:"min-content 1fr min-content",
                                    content: pre({content:"Description unavailable."})
                                })
                            }
                        }
                        getId("character-features").children[1].innerHTML = rows
                        if (rows) {
                            getId("character-features-container").setAttribute("style", "")
                        } else {
                            getId("character-features-container").setAttribute("style", "display:none")
                        }
                    }
                    
                    function updateProficiencies() { 
                        const level_names = {
                            0:"Proficiency",
                            1:"Expertise",
                            2:"Mastery",
                            3:"Grandmastery"
                        }

                        let rows = ""
                        for (const name in character.proficiencies) {
                            const level = Number(character.proficiencies[name])
                            const proficiency = database.proficiencies.data[name]

                            if(proficiency) {
                                const type = proficiency.type
                                let description = proficiency.description[0]
                                description += level >= 1 ? "<br><br>" + proficiency.description[1] : ""
                                description += level >= 2 ? "<br><br>" + proficiency.description[2] : ""
                                description += level >= 3 ? "<br><br>" + proficiency.description[3] : ""

                                const level_name = type == "language" ? "" : level_names[level] 

                                rows += row({
                                    columns:[
                                        proficiency.name + " " + level_name, capitalize(type)
                                    ], 
                                    config:"1fr min-content",
                                    content: pre({content:description})
                                })
                            } else {
                                rows += row({
                                    columns:[
                                        name + " " + "", ""
                                    ], 
                                    config:"1fr min-content",
                                    content: pre({content:"Description unavailable."})
                                })
                            }
                        }
                        getId("character-proficiencies").children[1].innerHTML = rows
                        if (rows) {
                            getId("character-proficiencies-container").setAttribute("style", "")
                        } else {
                            getId("character-proficiencies-container").setAttribute("style", "display:none")
                        }
                    }
                                        
                    function updateResistances() { 
                        let rows = ""
                        for (const name in character.resistances) {
                            const type = character.resistances[name].type
                            const reduction = character.resistances[name].reduction

                            const type_not_default = type != "default"

                            if (type_not_default || reduction != 0) {
                                const damage_type = database.damage_types.data[name]
                                const image_src = damage_type.image
                                let show_type
                                if(type_not_default) {
                                    show_type = capitalize(type)
                                } else {
                                    value = [
                                        "Bludgeoning", 
                                        "Piercing", 
                                        "Slashing"
                                    ].includes(name) ? Number(reduction) * 2 : reduction

                                    types = {
                                        10:"Lesser",
                                        20:"Medium",
                                        30:"Greater"
                                    }

                                    show_type = reduction
                                }
                                
                                const description = damage_type.description

                                rows += row({
                                    columns:[
                                        image({src:image_src, style:"height:2vh"}),
                                        capitalize(name),
                                        show_type,
                                    ],
                                    config:"min-content 1fr 1fr",
                                    content: pre({content:description})
                                })
                            }
                        }

                        getId("character-resistances").children[1].innerHTML = rows
                        if (rows) {
                            getId("character-resistances-container").setAttribute("style", "")
                        } else {
                            getId("character-resistances-container").setAttribute("style", "display:none")
                        }
                    }
                
                    updateConditions()
                    updateFeatures()
                    updateProficiencies()
                    updateResistances()
                    updateColapsible()
                })
            }
    
            function loadPage() {
                document.body.innerHTML = div({classes:"outer",style:"display:flex;justify-content: center;", id:"character-tab",content:(
                    div({id:"character-tab-left"}) + 
                    div({id:"character-tab-center"}) + 
                    div({id:"character-tab-right"})
                )})
            }
    
            function leftArea() {
                getId("character-tab-left").innerHTML += (
                    container({title:"Saving Throws", id:"saving-throws", content:(
                        ""
                    )}) +
                    container({title:"Skills", id:"skills", content:(
                        ""
                    )})
                );
            }
            function centerArea() {
                getId("character-tab-center").innerHTML += (
    
                    div({style:"height:1vh;"}) +
    
                    subtitle({content:"Name"}) +
                    element({tag:"h2", id:"name", content:""}) +
    
                    image({id:"portrait", src:""}) +
    
                    subtitle({content:"Class"}) +
                    element({tag:"h2", id:"class", content:""}) +
    
                    container({id:"ability-scores-container", title:"Ability Scores",style:"padding-top:2vh;margin-bottom: 1vh;", content:(
                        table({
                            headers:["STR", "DEX", "CON", "WIS", "INT", "CHA"],
                            config:"1fr 1fr 1fr 1fr 1fr 1fr",
                            header_style:"text-align:center;font-size:110%;color:#aaa"
                        }) +
                        table({
                            id:"ability-scores", 
                            headers:["0", "0", "0", "0", "0", "0"],
                            config:"1fr 1fr 1fr 1fr 1fr 1fr",
                            header_style:"text-align:center;font-size:130%"
                        }) 
                    )}) +
    
                    container({title:"Info", style:"margin-bottom:0", content_style:"height:39vh", content:(""
                    )}) +
                    
                    div({classes: "center-horizontal",style:`
                    position:absolute;bottom:4.5vh;margin-left:0.5vh;width: 80%;height:40vh; overflow-y:inherit;overflow-x:hidden;
                    `, content:(
                        title_value({
                            id:"type",
                            title:"Type",
                            value:"",
                        }) +
                        title_value({
                            id:"race",
                            title:"Race",
                            value:"",
                        }) +
                        "<hr>" +
                        title_value({
                            id:"health",
                            title:"Health",
                            value:"",
                        }) +
                        title_value({
                            id:"armor-class",
                            title:"Armor Class",
                            value:"",
                        }) +
                        title_value({
                            id:"initiative",
                            title:"Initiative",
                            value:"",
                        }) +
                        title_value({
                            id:"walking-speed",
                            title:"Speed",
                            value:"",
                        }) +
                        title_value({
                            id:"passive-perception",
                            title:"Passive Perception",
                            value:"",
                        }) +
                        "<hr>" +
                        title_value({
                            id:"level",
                            title:"Level",
                            value:"",
                        }) +
                        title_value({
                            id:"experience",
                            title:"Experience",
                            value:"",
                        }) 
                    )})
    
                )
            }
            function rightArea() {
                getId("character-tab-right").innerHTML += (
                    container({title:"Conditions", id:"character-conditions-container", content:(
                        table({
                            id:"character-conditions",
                            headers:["", ""],
                            config:"1fr min-content",
                            content:row({content:"A spell", columns:["Mage Armor", "1 round"], config:"1fr 1fr"})
                        })
                    )}) +
                    container({title:"Features", id:"character-features-container", content:(
                        table({
                            id:"character-features",
                            headers:["", ""],
                            config:"1fr min-content",
                            content:row({content:"a big description", columns:["Wizard Spellcasting", "Wizard"], config:"1fr 1fr"})
                        })
                    )}) +
                    container({title:"Proficiencies", id:"character-proficiencies-container", content:(
                        table({
                            id:"character-proficiencies",
                            headers:["", ""],
                            config:"1fr min-content",
                            content:(
                                row({content:"a big description", columns:["Sword", "Expertise"], config:"1fr 1fr"})
                            )
                        })
                    )}) +
                    container({title:"Resistances", id:"character-resistances-container", content:(
                        table({
                            id:"character-resistances",
                            headers:["", ""],
                            config:"1fr min-content",
                            content:(
                                row({content:"a big description", columns:["Fire", "Immunity"], config:"1fr 1fr"})
                            )
                        })
                    )})
                )
    
                updateColapsible()
            }
    
            function onWindowLoad() {
                loadPage()
                
                centerArea()
                leftArea()
                rightArea()
    
                updateCenter();setInterval(updateCenter, 200)
                updateLeft();setInterval(updateLeft, 200)
                updateRight();setInterval(updateRight, 200)
            }
    
            document.addEventListener("DOMContentLoaded", onWindowLoad)
    
            //=====================================================================================================
    
        </script>
        ']
    </head>
    
    <body>
    </body>
    
    }]