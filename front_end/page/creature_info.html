[h,if(argCount()>0):id = arg(0);id = getImpersonated()]

[dialog5("Character",  "width=400; height=800; temporary=0; input=1; noframe=0"), code: {
<head>
<link rel='onChangeImpersonated' type='macro' href="
    macro://creature_info.html@lib:main/all/impersonated?
">
[r:style()]
[r:script()]
[r:'
<style>
    .content-left, .content-right{
        min-height: 0px;
        display:block;
        margin: 0px;
    }
    .content-left {
        width: 60%;
        text-align: left;
    }
    .content-right {
        width: 40%;
        text-align: right;
    }    
    .content-left::first-letter, .content-right::first-letter{
        text-transform: capitalize;
    }
    .background {
        background-color:#333;
        border-radius: 5px;
        padding: 10px;
    }
    .background:hover {
        background-color:#444;
    }

    .outer {
        height: 92%;
    }

    .tab-switch-div {
        position:relative;
        height:20px;
        min-height: 30px;
        margin-bottom: -2px;
    }
    .tab-switch {
        z-index:0;
        bottom: 0px;
        min-height: 20px;
        position:absolute;
        width:30%;
        left: 50%;
        transform: translate(-50%);
        background-color: #292929;
        border: 2px solid #414141;
        border-radius: 10px;
        border-bottom-left-radius: 0px;
        border-bottom-right-radius: 0px;
        font-size: 100%;
        color: #ddd;
    }
    .tab-switch:hover {
        background-color: #444
    }

    .tab-switch.active{
        background-color: #414141
    }

    #character-switch {
        left: 19%
    }
    #skills-switch {
        left: 50%
    }
    #proficiencies-switch {
        left: 81%
    }
</style>
<script>

    //=====================================================================================================
    // Execution
    //=====================================================================================================

    function onWindowLoad() {

        animateAccordion()
        updateFields(); setInterval(()=>{
            updateFields()
        }, 500)

        updateConditions()
        updateFeatures()
        updateResistances()

        addTabFunctionality()

        getId("reset").addEventListener("click",()=>{
            openPage("creature_reset.html")
            closePage("Character Sheet")
        })
        
    }

    function addTabFunctionality() {
        let tab_list  = ["character", "skills", "proficiencies"]

        tab_list.forEach((tab_name) => {
            getId(tab_name+"-switch").addEventListener("click", () => {
                tab_list.forEach((value) => {
                    let button = getId(value+"-switch")
                    let div = getId(value+"-tab")
                    if (tab_name == value) {
                        button.setAttribute("class", "tab-switch active")
                        div.setAttribute("style", "")
                    } else {
                        button.setAttribute("class", "tab-switch")
                        div.setAttribute("style", "display:none")
                    }
                })
            })
        })
        
    }



    //=====================================================================================================
    // Sync management
    //=====================================================================================================

    function updateConditions() {
        let table = getId("conditions-table")
        let id = getId("id")

        toBackend("var creature = new Creature(`"+id.value+"`);"+"creature.conditions",
        (response) => {
            response = JSON.parse(response)
            let has_conditions = false
            let response_keys = Object.keys(response)

            response_keys.forEach((key)=>{
                let value = Number(response[key])
                has_conditions = true;

                let innerDivName = document.createElement("div")
                innerDivName.className = "content-left"
                innerDivName.innerHTML = key

                let unit = "Round"
                if (value > 14400) {
                    value /= 14400
                    unit = "Day"
                }
                else if (value > 600) {
                    value /= 600
                    unit = "Hour"
                }
                else if (value > 10) {
                    value /= 10
                    unit = "Minute"
                }

                value = Math.round(value)
                if (value > 1) {
                    unit += "s"
                }

                let innerDivType = document.createElement("div")
                innerDivType.className = "content-right"
                innerDivType.innerHTML = value + " " + unit

                let outerDiv = document.createElement("div")
                outerDiv.className = "row background"
                outerDiv.appendChild(innerDivName)
                outerDiv.appendChild(innerDivType)
                
                table.parentNode.appendChild(outerDiv)
            })

            if (!has_conditions) {
                getId("conditions-container").style = "display:none"
            } else {
                getId("conditions-container").style = ""
            }
        })
    }

    function updateFeatures() {
        let table = getId("features-table")
        let id = getId("id")

        toBackend("var creature = new Creature(`"+id.value+"`);"+"creature.features",
        (response) => {
            response = JSON.parse(response)
            let has_features = false;
            let response_keys = Object.keys(response)

            response_keys.forEach((key)=>{
                if (key != "all") {
                    response[key].forEach((value)=>{
                        has_features = true;

                        let innerDivName = document.createElement("div")
                        innerDivName.className = "content-left"
                        innerDivName.innerHTML = value

                        let innerDivType = document.createElement("div")
                        innerDivType.className = "content-right"
                        innerDivType.innerHTML = key

                        let outerDiv = document.createElement("div")
                        outerDiv.className = "row background"
                        outerDiv.appendChild(innerDivName)
                        outerDiv.appendChild(innerDivType)
                        
                        table.parentNode.appendChild(outerDiv)
                    })
                }
            })

            if (!has_features) {
                getId("features-container").style = "display:none"
            } else {
                getId("features-container").style = ""
            }
        })
    }

    function updateResistances() {
        let table = getId("resistances-table")
        let id = getId("id")

        toBackend("var creature = new Creature(`"+id.value+"`);"+"creature.resistances",
        (response) => {
            response = JSON.parse(response)
            let has_resistances = false;
            let response_keys = Object.keys(response)

            response_keys.forEach((key)=>{
                let value = response[key]
                if (value != 0) {
                    has_resistances = true;

                    let innerDivName = document.createElement("div")
                    innerDivName.className = "content-left"
                    innerDivName.innerHTML = key

                    let style = "";
                    switch(value) {
                        case "immunity":
                            style = "color: #d90"
                            break
                        case "heals":
                            style = "color: #090"
                            break
                        case "vulnerability":
                            style = "color: #a33"
                            break
                        default:
                            style = "color: #090"
                            break
                    }
                    let innerDivType = document.createElement("div")
                    innerDivType.className = "content-right"
                    innerDivType.innerHTML = value
                    innerDivType.style = style + ";font-weight: bold"

                    let outerDiv = document.createElement("div")
                    outerDiv.className = "row background"
                    outerDiv.appendChild(innerDivName)
                    outerDiv.appendChild(innerDivType)
                    
                    table.parentNode.appendChild(outerDiv)
                }
            })

            if (!has_resistances) {
                getId("resistances-container").style = "display:none"
            } else {
                getId("resistances-container").style = ""
            }
        })
    }

    //=====================================================================================================

    document.addEventListener("DOMContentLoaded", onWindowLoad)
</script>
']
</head>

<input type="text" class="hidden" id="id" value="{id}"></input>

<body>

    <div class="tab-switch-div">
        <button class="tab-switch active" id="character-switch">Character</button>
        <button class="tab-switch" id="skills-switch">Skills</button>
        <button class="tab-switch" id="proficiencies-switch">Proficiencies</button>
    </div>

    <div class="outer" id="character-tab">

        <h2 id="name"></h2>
        <img src="{getTokenPortrait(108,id)}" height="108px" style="
            border-radius: 108px;
            border: 2px solid #888;
        ">
        <h3 class="subtext" id="level">3rd Level</h3>
        <h2><span id="race">Human</span> <span id="class">Wizard</span></h2>

        <div class="spacer"></div>

        <div class="container center-horizontal"><h3 class="container-title">Attributes</h3>
            <div class="spacer"></div>

            <div class="row">
                <div class="stat">STR</div>
                <div class="stat">DEX</div>
                <div class="stat">CON</div>
                <div class="stat">WIS</div>
                <div class="stat">INT</div>
                <div class="stat">CHA</div>
            </div>
            <div class="row">
                <div class="value" id="str">12</div>
                <div class="value" id="dex">14</div>
                <div class="value" id="con">13</div>
                <div class="value" id="wis">10</div>
                <div class="value" id="int">8</div>
                <div class="value" id="cha">15</div>
            </div>
        </div>

        <div class="spacer"></div>

        <div class="container center-horizontal" id="conditions-container" style="display:none">
            <h3 class="container-title">Conditions</h3>
            <div class="table-content" id="conditions-table"></div>
            <p id="conditions"></p>
        </div>

        <div class="spacer"></div>

        <div class="container center-horizontal" id="features-container" style="display:none">
            <h3 class="container-title">Features</h3>
            <p id="features"></p>
            <div class="table-content" id="features-table"></div>
        </div>

        <div class="spacer"></div>

        <div class="container center-horizontal" id="resistances-container" style="display:none">
            <h3 class="container-title">Resistances</h3>
            <p id="resistances"></p>
            <div class="table-content" id="resistances-table"></div>
        </div>

        <div class="spacer"></div>

        <button id="reset">Reset Character</button>

    </div>

    <div class="outer" id="skills-tab" style="display:none">

    </div>

    <div class="outer" id="proficiencies-tab" style="display:none">

    </div>
</body>

}]