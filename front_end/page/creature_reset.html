[h,if(argCount()>0):id = arg(0);id = getImpersonated()]

[dialog5("Character", "width=400; height=800; temporary=0; input=1; noframe=0"), code: {
<head>
[r:style()]
[r:script()]
[r:'
<style>

.score-container {
    display: grid;
    grid-template-columns: repeat(3, 85px);  /* Adjust to fit within 450px */
    gap: 5px;
    grid-template-rows: repeat(2, 140px);
    width: fit-content; /* Set the width to 450px */
    margin: 0 auto; /* Automatically center horizontally */
    justify-items: center; /* Ensure items in the grid are centered horizontally */
    align-items: center; /* Ensure items in the grid are centered vertically */
}

.score {
    background-color: #333;
    width: 70px;
    border: 1px solid #444;
    border-radius: 5px;
    padding: 5px;
    padding-bottom: 8px;
    text-align: center;
    height: 120px;  /* Control the height for consistency */
}

.label {
    font-size: 100%; /* Smaller font size */
    font-weight: bold;
}

.score-value {
    font-size: 34px; /* Adjusted for a smaller look */
    font-weight: bold;
    width:fit-content;
    margin:auto;
    margin-top: 10px;
    margin-bottom: 0px;
    text-align:left;
}

.score-bonus {
    font-weight:700;
    width:fit-content;
    margin:auto;
    margin-top: 0px;
    margin-bottom: 10px;
    border: 1px solid #999;
    border-radius: 100px;
    padding: 3px;
    padding-right: 4px;
    font-size: 80%;
}

.increase, .decrease {
    padding: 0px;
    width: 20px;
    height: 20px;
    min-height: unset;
    min-width: unset;
}

</style>
<script>

    //=====================================================================================================
    // Execution
    //=====================================================================================================

    function onWindowLoad() {

        let id = getId("id")

        loadCurrentFieldValue("name", "creature.name")
        loadCurrentFieldValue("type", "creature.type")
        loadCurrentFieldValue("race", "creature.race")

        addSubmitBehavior()
        addAbilityScoresBehavior()

        getId("cancel").addEventListener("click", () => {
            openPage("character_info.html")
        })

        getId("type").addEventListener("input", () => {
            updateRaceVisibility()
        })
        
        getId("race").addEventListener("input", () => {
            updateRaceBonus()
        })

        setTimeout(()=>{
            updateRaceBonus()
        }, 250)
    }



    //=====================================================================================================
    // Helper functions
    //=====================================================================================================

    function addSubmitBehavior() {
        getId("submit").addEventListener("click", async () => {

            // Get values from form
            let name = getId("name");
            let type = getId("type");
            let race = getId("race");

            // Get attribute values from form
            let str = getId("strength");
            let dex = getId("dexterity");
            let con = getId("constitution");
            let wis = getId("wisdom");
            let int = getId("intelligence");
            let cha = getId("charisma");

            // Check if form is valid
            let valid = true
            if (name.value == "") {valid = false}
            if (type.value == "") {valid = false}
            if (race.value == "" && type.value == "Humanoid") {valid = false}
            if (valid == false) {return}

            race_value = type.value != "Humanoid" ? type.value : race.value


            // Send data to backend
            toBackend(
                "var creature = new Creature(`"+id.value+"`, true);"+
                "creature.create("+
                    "`"+name.value+"`,"+
                    "`"+type.value+"`,"+
                    "`"+race_value+"`,"+
                    "`"+str.getAttribute("value")+"`,"+
                    "`"+dex.getAttribute("value")+"`,"+
                    "`"+con.getAttribute("value")+"`,"+
                    "`"+wis.getAttribute("value")+"`,"+
                    "`"+int.getAttribute("value")+"`,"+
                    "`"+cha.getAttribute("value")+"`,"+
                ")"
            )

            openPage("character_info.html")

        })
    }
    
    function updateAttributeBonus() {
            let str = getId("strength");
            let dex = getId("dexterity");
            let con = getId("constitution");
            let wis = getId("wisdom");
            let int = getId("intelligence");
            let cha = getId("charisma");
            let ability_score_list = [str, dex, con, wis, int, cha]

            ability_score_list.forEach((ability_score) => {
                let attribute_bonus = getId("bonus_" + ability_score.id)

                attribute_bonus.innerHTML = Math.abs(Math.floor((Number(ability_score.innerHTML)-10)/2))
                if(Number(ability_score.innerHTML) >= 10) {
                    attribute_bonus.innerHTML = "+ " + attribute_bonus.innerHTML
                }
                else if(Number(ability_score.innerHTML) < 10) {
                    attribute_bonus.innerHTML = "- " + attribute_bonus.innerHTML
                }
            })
        }

    function addAbilityScoresBehavior() {
        let str = getId("strength");
        let dex = getId("dexterity");
        let con = getId("constitution");
        let wis = getId("wisdom");
        let int = getId("intelligence");
        let cha = getId("charisma");
        let ability_score_list = [str, dex, con, wis, int, cha]
        function availablePoints() {
            let total_points = 27
            
            ability_score_list.forEach((ability_score) => {
                let value = 0
                value = ability_score.getAttribute("value")

                let additional_cost = Math.max(value - 13, 0)
                let cost = Math.max(value - 8, 0)

                total_points = total_points - cost - additional_cost
            })

            return total_points 
        }
        function updatePoints() {
            getId("points").innerHTML = availablePoints()
        }

        // Add ability score value to scores, and behavior to increase/decrease buttons
        ability_score_list.forEach((ability_score) => {
            ability_score.setAttribute("value", ability_score.innerHTML)
            let decrease_button = getId("reduce_" + ability_score.id)
            let increase_button = getId("increase_" + ability_score.id)
            
            decrease_button.addEventListener("click", () => {
                let value = Number(ability_score.getAttribute("value"))

                if (value > 8) {
                    ability_score.setAttribute("value", value - 1)
                    ability_score.innerHTML = Number(ability_score.innerHTML) - 1
                }

                updateAttributeBonus()
                updatePoints()
            })
            increase_button.addEventListener("click", () => {
                let value = Number(ability_score.getAttribute("value"))

                if (value < 15) {
                    let cost = 0
                    if (value >= 13) {cost = 2}
                    else {cost = 1}

                    if (availablePoints() - cost < 0) {return}

                    ability_score.setAttribute("value", value + 1)
                    ability_score.innerHTML = Number(ability_score.innerHTML) + 1
                }

                updateAttributeBonus()
                updatePoints()
            })
        })

        updateAttributeBonus
        updatePoints()
    }

    function updateRaceVisibility() {
        let type = getId("type")
        let race_div = getId("race-div")

        if (type.value == "Humanoid") {
            race_div.setAttribute("style", "display: block")}
        else {
            race_div.setAttribute("style", "display: none")}
    }

    function updateRaceBonus() {
        let type = getId("type")
        let race = getId("race")

        let str = getId("strength");
        let dex = getId("dexterity");
        let con = getId("constitution");
        let wis = getId("wisdom");
        let int = getId("intelligence");
        let cha = getId("charisma");
        let ability_score_list = [str, dex, con, wis, int, cha]

        ability_score_list.forEach((ability_score) => {
            if(ability_score.getAttribute("value")) {
                ability_score.innerHTML = ability_score.getAttribute("value")
            }
        })

        switch (race.value) {
            case "Hill Dwarf":
                con.innerHTML = Number(con.innerHTML) + 2;
                wis.innerHTML = Number(wis.innerHTML) + 1;
                break;

            case "Mountain Dwarf":
                con.innerHTML = Number(con.innerHTML) + 2;
                str.innerHTML = Number(str.innerHTML) + 2;
                break;

            case "High Elf":
                dex.innerHTML = Number(dex.innerHTML) + 2;
                int.innerHTML = Number(int.innerHTML) + 1;
                break;

            case "Wood Elf":
                dex.innerHTML = Number(dex.innerHTML) + 2;
                wis.innerHTML = Number(wis.innerHTML) + 1;
                break;

            case "Drow":
                dex.innerHTML = Number(dex.innerHTML) + 2;
                cha.innerHTML = Number(cha.innerHTML) + 1;
                break;

            case "Lightfoot Halfling":
                dex.innerHTML = Number(dex.innerHTML) + 2;
                cha.innerHTML = Number(cha.innerHTML) + 1;
                break;

            case "Stout Halfling":
                dex.innerHTML = Number(dex.innerHTML) + 2;
                con.innerHTML = Number(con.innerHTML) + 1;
                break;

            case "Half-Orc":
                str.innerHTML = Number(str.innerHTML) + 2;
                con.innerHTML = Number(con.innerHTML) + 1;
                break;

            case "Human":
                str.innerHTML = Number(str.innerHTML) + 1;
                dex.innerHTML = Number(dex.innerHTML) + 1;
                con.innerHTML = Number(con.innerHTML) + 1;
                wis.innerHTML = Number(wis.innerHTML) + 1;
                int.innerHTML = Number(int.innerHTML) + 1;
                cha.innerHTML = Number(cha.innerHTML) + 1;
                break;

            case "Half-Elf":
                dex.innerHTML = Number(dex.innerHTML) + 1;
                int.innerHTML = Number(int.innerHTML) + 1;
                wis.innerHTML = Number(wis.innerHTML) + 1;
                cha.innerHTML = Number(cha.innerHTML) + 1;
                break;

            case "Gnome":
                int.innerHTML = Number(int.innerHTML) + 2;
                break;

            case "Rock Gnome":
                int.innerHTML = Number(int.innerHTML) + 2;
                con.innerHTML = Number(con.innerHTML) + 1;
                break;

            case "Forest Gnome":
                int.innerHTML = Number(int.innerHTML) + 2;
                dex.innerHTML = Number(dex.innerHTML) + 1;
                break;
        }

        updateAttributeBonus()

    }


    //=====================================================================================================

    document.addEventListener("DOMContentLoaded", onWindowLoad)

</script>
']
</head>

<input type="text" class="hidden" id="id" value="{id}"></input>

<body>
    <div class="outer center">

        <div class="container center-horizontal" style="padding-bottom:0px;"><h3 class="container-title">Information</h3>
            <div class="spacer" ></div>
            <h4>Name</h4>
            <input type="text" id="name" placeholder></input>
            <h4>Type</h4>
            <select id="type">
                <option value="" hidden>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                </option>
                <option>Aberration</option>
                <option>Beast</option>
                <option>Celestial</option>
                <option>Construct</option>
                <option>Dragon</option>
                <option>Elemental</option>
                <option>Fey</option>
                <option>Fiend</option>
                <option>Giant</option>
                <option>Humanoid</option>
                <option>Monstrosity</option>
                <option>Ooze</option>
                <option>Plant</option>
                <option>Undead</option>
            </select>
            <div id="race-div">
                <h4>Race</h4>
                <select id="race">
                    <option value="" hidden>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </option>
                    <option>Hill Dwarf</option>
                    <option>Mountain Dwarf</option>
                    <option>High Elf</option>
                    <option>Wood Elf</option>
                    <option>Drow</option>
                    <option>Lightfoot Halfling</option>
                    <option>Stout Halfling</option>
                    <option>Half-Orc</option>
                    <option>Human</option>
                    <option>Half-Elf</option>
                    <option>Rock Gnome</option>
                    <option>Forest Gnome</option>
                </select>
            </div>
        </div>

        <div class="spacer"></div>

        <div class="container center-horizontal" style="padding-bottom:15px">
            <div class="spacer" ></div>
            <h3 class="container-title">Attribute Scores</h3>
            <h4>Available Points: <span id="points"></span> / 27</h4>
            <div class="spacer"></div><div class="spacer"></div>
            <div class="score-container">
                <div class="score">
                    <div class="label">Strength</div>
                    <div class="score-value" id="strength">8</div>
                    <div class="score-bonus" id="bonus_strength">- 1</div>
                    <button class="decrease" id="reduce_strength">-</button>
                    <button class="increase" id="increase_strength">+</button>
                </div>
                <div class="score">
                    <div class="label">Dexterity</div>
                    <div class="score-value" id="dexterity">8</div>
                    <div class="score-bonus" id="bonus_dexterity">- 1</div>
                    <button class="decrease" id="reduce_dexterity">-</button>
                    <button class="increase" id="increase_dexterity">+</button>
                </div>
                <div class="score">
                    <div class="label">Constitution</div>
                    <div class="score-value" id="constitution">8</div>
                    <div class="score-bonus" id="bonus_constitution">- 1</div>
                    <button class="decrease" id="reduce_constitution">-</button>
                    <button class="increase" id="increase_constitution">+</button>
                </div>
                <div class="score">
                    <div class="label">Wisdom</div>
                    <div class="score-value" id="wisdom">8</div>
                    <div class="score-bonus" id="bonus_wisdom">- 1</div>
                    <button class="decrease" id="reduce_wisdom">-</button>
                    <button class="increase" id="increase_wisdom">+</button>
                </div>
                <div class="score">
                    <div class="label">Intelligence</div>
                    <div class="score-value" id="intelligence">8</div>
                    <div class="score-bonus" id="bonus_intelligence">- 1</div>
                    <button class="decrease" id="reduce_intelligence">-</button>
                    <button class="increase" id="increase_intelligence">+</button>
                </div>
                <div class="score">
                    <div class="label">Charisma</div>
                    <div class="score-value" id="charisma">8</div>
                    <div class="score-bonus" id="bonus_charisma">- 1</div>
                    <button class="decrease" id="reduce_charisma">-</button>
                    <button class="increase" id="increase_charisma">+</button>
                </div>
            </div>
        </div>

        <div class="spacer"></div>

        <button id="cancel">Cancel</button>
        <button id="submit">Accept</button>

    </div>
</body>

}]