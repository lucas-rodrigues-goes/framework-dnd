[h,if(!argCount()>0):id = arg(0); id = getImpersonated()]
[h,if(id==""):id = getImpersonated()]

[dialog5("Inventory", "width=325; height=800; temporary=1; input=1; noframe=0"), code: {
<head>
    <script>
        const id = "{id}"
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="style.css@lib:front"></link>
    [r:scriptTag("open")][r:importScript("script.js@lib:front")][r:scriptTag("close")]
    [r:scriptTag("open")][r:importScript("components.js@lib:front")][r:scriptTag("close")]

    [r:'
    <style>

    .inventory-slot {
        background-color:#222;
        border: 0.2vh solid #555;
        border-radius: 0.5vh;

        height: 5vh;
        width: 5vh;

        transition: background-color 0.2s ease;
    }

    .inventory-slot:hover {
        background-color:#333
    }

    .inventory-item {
        position:relative;
        height: 95%;
        top:2.5%;
        cursor:pointer;
    }

    .inventory-item-amount {
        position:absolute;
        font-weight:bold; 
        bottom:-0.4vh; 
        right:0;
        text-shadow: 0.1vh 0.1vh 0.2vh rgba(0, 0, 0, 1), -0.1vh -0.1vh 0.2vh rgba(0,0,0,1);
    }

    .tooltip-item::after {
        position: absolute;
        top: 115%;
        height:fit-content;
        font-weight: bold;
    }

    </style>
    <script>

    //=====================================================================================================
    // Helper functions
    //=====================================================================================================

    let draggedElement = null;
    let initialPosition = null;

    function dragStart(event) {
        draggedElement = event.target;
        draggedElement.parentNode.classList.remove("tooltip","tooltip-item")
        initialPosition = draggedElement.dataset.position;
    }

    function dragEnd(event) {
        draggedElement.style.visibility = "visible";
    }

    function dragOver(event) {
        event.preventDefault();
    }

    function drop(event) {
        event.preventDefault();
        const target = event.target.closest(".inventory-slot");

        if (target) {
            const finalPosition = target.dataset.position;

            toBackend(` impersonated().move_item(`+initialPosition+`, `+finalPosition+`) `)
            updateInventory()

            // Reset draggedElement visibility without moving it
            draggedElement.style.visibility = "hidden";
        }
    }

    function updateInventory() {

        const max_inventory_size = 20
        
        toBackend(" [impersonated().inventory , database.items.data] ", (response) => {

            const new_hash = hash(response)
            const old_hash = getId("inventory").getAttribute("hash")
            if (new_hash == old_hash) { return }
            getId("inventory").setAttribute("hash", new_hash)

            response = JSON.parse(response)
            
            const inventory = response[0]
            const item_database = response[1]

            const grid = getId("inventory")
            grid.innerHTML = ""

            const items = []
            let cells = ""

            for (let i = 0; i < max_inventory_size; i++) {
                const slot = inventory[i]
                const item = slot ? item_database[slot.name] : null

                slot_tooltip = ""
                slot_classes = "inventory-slot "
                slot_content = ""

                if (item) {
                    slot_tooltip = item.name
                    slot_classes += "tooltip tooltip-item "
                    slot_content = img({
                        src:item.image, 
                        additional:`draggable data-position="`+i+`"`,
                        classes:"inventory-item"
                    })

                    slot_tooltip = slot.amount > 1 ? slot.amount + " " + slot_tooltip + "s" : slot_tooltip
                    slot_content += slot.amount > 1 ? span({content:slot.amount, classes:"inventory-item-amount"}) : ""

                    weight = Math.round(item.weight * slot.amount * 100) / 100
                    slot_tooltip += " (" + weight + "lb)"

                    items.push(i)
                }

                cells += div({
                    id:"inventory-slot-"+i,
                    classes:slot_classes,
                    content:slot_content,
                    tooltip:slot_tooltip,
                    additional: `data-position="`+i+`"`
                })
            }

            getId("inventory").innerHTML = cells
            
            for (let i = 0; i < max_inventory_size; i++) {
                target_id = "inventory-slot-"+i

                slot = getId(target_id)
                slot.addEventListener("dragover", dragOver); slot.addEventListener("drop", drop);

                if(items.includes(i)) {
                    item = slot.children[0]
                    item.addEventListener("dragstart", dragStart); item.addEventListener("dragend", dragEnd);

                    loadContextMenu({target_id, context_menu_id:"item-context-menu", onOpen:() => {

                        // Send
                        getId("item-context-menu-send").addEventListener("click", ()=>{
                            toBackend(` impersonated().send_item(`+i+`) `)
                            updateInventory()
                        })

                        // Drop
                        getId("item-context-menu-drop").addEventListener("click", ()=>{
                            toBackend(` impersonated().drop_item(`+i+`) `)
                            updateInventory()
                        })

                    }})
                }

            }
        })
    }

    //=====================================================================================================
    // Execution
    //=====================================================================================================

    function loadPage() {
        
        document.body.innerHTML = (
            context_menu({content:["equip", "send", "drop"], id:"item-context-menu"}) +
            div({classes:"outer", style:"overflow:hidden;", id:"content"})
        )

        getId("content").innerHTML += (
            container({title:"Equipment", content:(
                div({style:"height:30vh"})
            )}) +
            container({title:"Inventory", content:(
                div({style: "margin-auto",content:(
                    grid({
                        id:"inventory",
                        classes: "center-horizontal",
                        style: "position:relative; width:30vh; text-align:center; place-items:center; margin-top:2vh;",
                        columns: 5,
                        gap:"0.2vh"
                    })
                )})
            )}) +
            container({title:"Item Description", content:(
                div({style:"height:12.5vh", content:"<br>Select an item to see its description."})
            )})
        )
    }

    function onWindowLoad() {

        // Body HTML
        loadPage()

        updateInventory(); setInterval(updateInventory, 200)
    }



    //=====================================================================================================

    document.addEventListener("DOMContentLoaded", onWindowLoad)

    </script>
    ']
</head>

<body>
</body>

}]