[h,if(!argCount()>0):id = arg(0); id = getImpersonated()]
[h,if(id==""):id = getImpersonated()]

[dialog5("Inventory", "width=400; height=800; temporary=1; input=1; noframe=0"), code: {
<head>
    <script>
        const id = "{id}"
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="style.css@lib:front"></link>
    [r:scriptTag("open")][r:importScript("script.js@lib:front")][r:scriptTag("close")]
    [r:scriptTag("open")][r:importScript("components.js@lib:front")][r:scriptTag("close")]

    [r:'
    <style>

    .inventory-slot {
        background-color:#222;
        border: 0.2vh solid #555;
        border-radius: 0.5vh;

        height: 5.5vh;
        width: 5.5vh;

        transition: background-color 0.2s ease;
    }

    .inventory-slot:hover {
        background-color:#333
    }

    .inventory-item {
        position:relative;
        height: 4.4vh;
        top:10%
    }

    .tooltip-item::after {
        position: absolute;
        top: 115%;
        height:fit-content;
        font-weight: bold;
    }

    </style>
    <script>

    //=====================================================================================================
    // Helper functions
    //=====================================================================================================

    let draggedElement = null;
    let initialPosition = null;

    function dragStart(event) {
        draggedElement = event.target;
        draggedElement.parentNode.classList.remove("tooltip","tooltip-item")
        initialPosition = draggedElement.dataset.position;
    }

    function dragEnd(event) {
        draggedElement.style.visibility = "visible";
    }

    function dragOver(event) {
        event.preventDefault();
    }

    function drop(event) {
        event.preventDefault();
        const target = event.target.closest(".inventory-slot");

        if (target) {
            const finalPosition = target.dataset.position;

            toBackend(` impersonated().move_item(`+initialPosition+`, `+finalPosition+`) `)
            updateInventory()

            // Reset draggedElement visibility without moving it
            draggedElement.style.visibility = "hidden";
        }
    }

    function updateInventory() {
        
        toBackend(" [impersonated().inventory , database.items.data] ", (response) => {
            response = JSON.parse(response)
            
            const inventory = response[0]
            const item_database = response[1]

            const grid = getId("inventory")
            grid.innerHTML = ""

            items = []

            for (let i = 0; i < 20; i++) {
                const slot = inventory[i]
                const item = slot ? item_database[slot.name] : null
                
                const grid_slot = document.createElement("div");
                grid_slot.className = "inventory-slot";
                grid_slot.dataset.position = i;
                grid_slot.addEventListener("dragover", dragOver);
                grid_slot.addEventListener("drop", drop);


                if (item) {
                    const img = document.createElement("img");
                    
                    grid_slot.className = "tooltip tooltip-item inventory-slot";
                    grid_slot.setAttribute("tooltip", item.name)
                    grid_slot.setAttribute("id", "inventory-slot-"+i)

                    img.draggable = true;
                    img.className = "inventory-item";
                    img.dataset.position = i;
                    img.src = item.image;
                    img.addEventListener("dragstart", dragStart);
                    img.addEventListener("dragend", dragEnd);

                    grid_slot.appendChild(img);

                    items.push(i)
                }
                
                grid.appendChild(grid_slot);
            }
            
            for (const i of items) {

                loadContextMenu({target_id:"inventory-slot-"+i, context_menu_id:"item-context-menu", onOpen:() => {
                    getId("item-context-menu-drop").addEventListener("click", ()=>{
                        toBackend(` impersonated().drop_item(`+i+`) `)
                        updateInventory()
                    })
                }})

            }
        })
    }

    //=====================================================================================================
    // Execution
    //=====================================================================================================

    function loadPage() {

        grid_content = ""
        for (let i=0; i<18; i++) {
            grid_content += (
                div({classes:"inventory-slot", id:"inventory-"+i+"-slot"})
            )
        }
        
        document.body.innerHTML = (
            context_menu({content:["equip", "send", "drop"], id:"item-context-menu"}) +
            div({classes:"outer", style:"overflow:hidden;", id:"content"})
        )

        getId("content").innerHTML += (
            container({title:"Inventory", content:(
                div({style: "margin-auto",content:(
                    grid({
                        id:"inventory",
                        classes: "center-horizontal",
                        style: "position:relative; width:32.5vh; text-align:center; place-items:center; margin-top:2vh;",
                        columns: 5,
                        gap:"0.5vh", 
                        content:grid_content
                    })
                )})
            )})
        )
    }

    function onWindowLoad() {

        // Body HTML
        loadPage()

        updateInventory()
    }



    //=====================================================================================================

    document.addEventListener("DOMContentLoaded", onWindowLoad)

    </script>
    ']
</head>

<body>
</body>

}]