[overlay("Screen"), code: {
<head>
<script>
    const gm = "{isGM()}" == "1"
</script>
[r:style()]
[r:script()]
[r:'
<style>

    /*===================================================================================================*/
    /* Document */
    /*===================================================================================================*/

    body {
        all:unset;
        font-size: 1.7vh;
    }

    .left, .right, .bottom, .top, .center-horizontal {position:fixed;}

    .menu {
        position: fixed;

        padding: 1vh 0.5vw;
        margin: 0.5vh;

        display: flex;
        align-items: end;
        gap: 1vh;
    }



    /*===================================================================================================*/
    /* Button */
    /*===================================================================================================*/

    .button-background {
        background-color: #333;
        border: 0.2vh solid #444;
        border-radius: 1vh;
        padding: 0.3vh;
        padding-left: 0.4vh;
        display:flex;

        background-color: rgba(0,0,0,0);
        border: none;
    }

    .button-background img {
        background-color: #292929;
        border: 0.3vh solid #444;
        border-radius: 0.5vh;
        display:block;
        height: 3vh;
        padding: 0.5vh;
        margin: 0 0.25vh;
        min-height:29px;
    }

    .button-background img:hover {
        background-color: #444;
        border: 0.3vh solid #555;
        opacity:1;
    }
    .button-background img:active {
        background-color: #555;
        opacity:1;
    }



    /*===================================================================================================*/
    /* Circular Health Bar */
    /*===================================================================================================*/

    .circular-health {
        position: relative;
        width: 13vh;
        height: 13vh;
        margin: -0.5vh 0px;

        background: rgba(0,0,0,0.15);
        border-radius: 50%;
        border: 0.2vh solid #444;

        display: flex;
        justify-content: center;
        align-items: center;
    }

    .circular-health > img {
        border-radius: 50%;
        border: 0.3vh solid #444;
        height: 11.5vh;
    }
    
    .circular-health > img:hover {
        filter: brightness(1.1)
    }

    .circular-health > img:active {
        filter: brightness(1.3)
    }

    #party-characters {
        position: absolute;
        bottom: 13.5vh;
    }

    #party-characters > .circular-health {
        width: 6.5vh;
        height: 6.5vh;
        min-height: 0;
        min-width: 0;
        margin: 1vh 0vh;
    }

    #party-characters > .circular-health > img {
        height: 5.5vh;
        min-height: 0;
    }



    /*===================================================================================================*/
    /* Target */
    /*===================================================================================================*/

    #target {
        top: 1vh;
    }

    #target > .top {
        width: fit-content;
        position: relative;

        bottom: -1vh;
        height: 6vh;

        color: #ddd;

        display: flex;
        align-items: center;
        justify-content: center;
    }

    #target img {
        position: absolute;
        height: 4vh;
        left: -5vh;
        border-radius: 50%;
        border: 0.1vh solid #444;
    }

    #target-health {
        position: relative;
        width: 35vh;
        
        height: 1.5vh;
        bottom: 0px;
        background-color: rgba(0,0,0,0.15);
        border-radius: 1vh;
        border: 0.3vh solid #444;
    }

    #target .armor-class {
        position:relative;
        display:inline;

        color:#ddd;
        text-align: center;
        font-weight: bold;
        font-size: 110%;

        background-color: #444;
        border: 0.3vh solid #555;
        border-radius: 50%;
        border-top-right-radius: 0;
        border-top-left-radius: 0;

        padding: 0.5vh;
        width:2vh;
        left: 1vh;
    }

    .text-shadow {
        text-shadow: 0.3vh 0.3vh 0.5vh rgba(0, 0, 0, 1), -0.3vh -0.3vh 0.5vh rgba(0,0,0,1)
    }



    /*===================================================================================================*/

</style>
<script>

    //=====================================================================================================
    // Helper functions
    //=====================================================================================================

    function getColor(value) {

        // Ensure value is within the range 0 to 100
        value = Number(value)
        value = Math.max(0, Math.min(100, value));

        // Calculate the proportion for interpolation
        let red, green;

        if (value >= 50) {
            // From yellow (50) to green (100)
            green = 255;
            red = Math.round(255 * (1 - (value - 50) / 50));
        } else {
            // From red (0) to yellow (50)
            red = 255;
            green = Math.round(255 * (value / 50));
        }

        // Adjust color intensity based on toneFactor
        red = Math.round(red * 0.7);
        green = Math.round(green * 0.7);

        // Clamp the values to ensure they stay within 0-255
        red = Math.min(255, Math.max(0, red));
        green = Math.min(255, Math.max(0, green));

        // Return the color in RGB format
        //return `#ddd`
        return `rgba(`+red+`, `+green+`, `+80+`, 1)`;
    }

    function hash(string) {
        let hash = 0;

        if (string.length == 0) return hash;

        for (i = 0; i < string.length; i++) {
            char = string.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }

        return hash;
    }

    //=====================================================================================================
    // Components
    //=====================================================================================================

    function target_character(name="", type="", image="", style="", armor_class="") {
        if (image != "") {
            image = `
            <img src="`+image+`">
            `
        }

        armor_class = armor_class ? `
            <div class="armor-class">`+armor_class+`</div>
        ` : "";

        return `
        <div id="target" class="center-horizontal">
            <div class="top center-horizontal">
                `+image+`
                <p>
                    <span class="text-shadow" style="font-size:120%;font-weight:bold; ">
                        `+name+`
                    </span><br>
                    <span class="text-shadow" style="color:#aaa;">
                        `+type+`
                    </span>
                </p>
            </div>
            <div id="target-health" style="`+style+`"></div>
            <div style="display:flex; gap: 1vh">
                `+armor_class+`
            </div>
        </div>
        `
    }

    function current_character(style="", image="") {
        click = "toBackend(`impersonated().go_to() ; impersonated().select()`)"
        return `
        <div id="health" class="circular-health" style="`+style+`">
            <img id="character-image" src="`+image+`" onclick="`+click+`">
        </div>`
    }

    function party_character(id="", image="", style="") {
        return `
        <div id="party-health-`+id+`" class="circular-health" style="`+style+`">
            <img id="party-image-`+id+`" src="`+image+`">
        </div>`
    }

    function div(id = "", classes = "", children = "") {
        return `
        <div id="`+id+`" class="`+classes+`">
        `+children+`
        </div>
        `
    }

    function image(id="", image="") {
        return `
        <img id="`+id+`" src="`+image+`">
        `
    }

    //=====================================================================================================
    // Execution
    //=====================================================================================================

    function currentCharacter() {
        toBackend(`impersonated()`, (response)=>{
            if (!response) {
                getId("character-menu").setAttribute("style", "display:none")
                return
            } else {
                getId("character-menu").setAttribute("style", "")
            }
        })
        toBackend(`
            [impersonated().health, impersonated().max_health, impersonated().portrait]`
        , (response)=>{
            new_hash = hash(response)
            old_hash = getId("current-character").getAttribute("hash")
            if(old_hash == new_hash) {return}

            getId("current-character").setAttribute("hash", new_hash)
            getId("current-character").innerHTML = ""

            character = JSON.parse(response)

            let health = character[0]
            let max_health = character[1]
            let hp_percent = health/max_health * 100
            let start_hp = hp_percent
            let end_hp = hp_percent != 0 ? hp_percent + 2 : 0;

            let image = character[2]
            let style = `background: linear-gradient(0deg, `+getColor(hp_percent)+` `+start_hp+`%, rgba(0,0,0,0.15) `+end_hp+`%);`

            getId("current-character").innerHTML += 
                current_character(style, image)
        })
    }

    function currentTarget() {
        toBackend(`MapTool.tokens.getSelectedTokens()`, (response) => {
            const valid_class = ["Creature"]
            selected_tokens = JSON.parse(response)

            if (selected_tokens.length != 1) { 
                getId("current-target").setAttribute("hash", "")
                getId("current-target").innerHTML = ""
                return
            }

            toBackend(`
                var target = instance("`+selected_tokens[0]+`"); 
                [target.health, target.max_health, target.name,
                 target.type, target.race, target.portrait, 
                 target.player, target.armor_class, target.token.getProperty("class")]`
            , (response)=>{
                target = JSON.parse(response)
                
                new_hash = hash(response)
                old_hash = getId("current-target").getAttribute("hash")
                if(old_hash == new_hash) {return}

                getId("current-target").setAttribute("hash", new_hash)
                getId("current-target").innerHTML = ""

                let name = target[2] || ""
                let type = target[4] || target[3] || target[8] || "Entity"
                let image = target[5] || ""
                let armor_class = target[7]

                let health = target[0] || 100
                let max_health = target[1] || 100
                let hp_percent = health/max_health * 100

                let color = target[6] == "true" ? "#5ab350" : "#b44"
                color = !valid_class.includes(target[8]) ? "#666" : color

                let style = `background: linear-gradient(90deg, `+color+` `+hp_percent+`%, rgba(0,0,0,0.5) `+hp_percent+`%);`

                getId("current-target").innerHTML += 
                    target_character(name, type, image, style, armor_class)
            })
        })
    }

    function currentParty() {
        toBackend(`
            [party_info(), getImpersonated()]`
        , (response) => {
            new_hash = hash(response)
            old_hash = getId("party-characters").getAttribute("hash")
            if(old_hash == new_hash) {return}

            party_members = JSON.parse(response)[0]
            current_id = JSON.parse(response)[1]

            getId("party-characters").setAttribute("hash", new_hash)
            getId("party-characters").innerHTML = ""
            
            items = []
            for (const member of party_members) {
                let member_id = member[3]
                if(member_id == current_id) {continue}
                
                let image = member[2]

                let health = member[0]
                let max_health = member[1]
                let hp_percent = health/max_health * 100
                let end_hp = hp_percent != 0 ? hp_percent + 2 : 0;

                let style = `background: linear-gradient(0deg, `+getColor(hp_percent)+` `+hp_percent+`%, rgba(0,0,0,0.15) `+end_hp+`%);`

                items.push(member_id)
                getId("party-characters").innerHTML +=
                    party_character(member_id, image, style)
            }

            for(const member_id of items) {
                getId("party-image-"+member_id).addEventListener("click",()=>{
                    toBackend(`
                        var party_member = new Creature("`+member_id+`");
                        party_member.go_to();
                        party_member.select();
                    `)
                    if(gm) {
                        toBackend(`party_member.impersonate();`)
                    }
                })
            }
        })
    }

    function loadPage() {
        getId("content").innerHTML +=
            div("character-menu", "menu bottom left", 
                div("current-character", "", "") +
                div("party-characters", "", "") +
                div("","button-background",
                    image("info","asset://3432c572c31826e72dedd81ef4a10c5b") +
                    image("inventory","asset://711c8f12938d7ef430fbcf7e2e5845ae") +
                    image("journal", "asset://4e98be9419bf1ce960319891b66add73") +
                    image("abilities", "asset://65479d57a2b1ffc116a12a5c731d91a7")
                
                )
            ) +
            div("gm-menu", "menu bottom right", 
                div("", "button-background",
                    image("create-character","asset://3432c572c31826e72dedd81ef4a10c5b") +
                    image("database", "asset://f218b6ad34fe8564e0553dc2bba91cc8")
                )
            ) +
            div("current-target")
        
        if (!gm) {getId("gm-menu").setAttribute("style", "display:none")}

        getId("info").addEventListener("click",()=>{ openClosePage("", "Character", "creature_info.html") })
        getId("create-character").addEventListener("click", ()=>{
            toBackend(`getImpersonated()`, (response)=>{
                openClosePage(response, "Character Creation", "character_creation.html")
            })
        })
        getId("database").addEventListener("click",()=>{ openClosePage("", "Database", "database.html") })
    }

    function onWindowLoad() {
        loadPage()

        currentCharacter(); setInterval(currentCharacter, 200)
        currentParty(); setInterval(currentParty, 200)
        currentTarget(); setInterval(currentTarget, 200)
    }



    //=====================================================================================================

    document.addEventListener("DOMContentLoaded", onWindowLoad)

</script>
']
</head>

<body>
    
    <div id="content"></div>

</body>

}]