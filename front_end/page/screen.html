    [h:id = getImpersonated()]
    [h:abort(arg(0) != id)]

    [overlay("Screen"), code: {
    <head>
    <link rel='onChangeImpersonated' type='macro' href='macro://screen.html@lib:main/impersonated/impersonated?{id}'>
    <script>
        const id = "{id}";
        const gm = "{isGM()}" == "1"
        const character_image = `{getTokenPortrait("",id)}`
    </script>
    [r:style()]
    [r:script()]
    [r:'
    <style>

        body {
            all:unset;
            font-size: 1.7vh;
        }

        .left, .right, .bottom, .top, .center-horizontal {position:fixed;}
        .left { left: 0; }
        .right { right: 0; }
        .bottom { bottom: 0; }
        .top { top: 0; }
        .center-horizontal { left: 50%; transform:translate(-50%)}

        .menu {
            position: fixed;

            padding: 1vh 0.5vw;

            display: flex;
            align-items: end;
            gap: 1vh;
        }

        .circular-health {
            position: relative;
            width: 12.5vh;
            height: 12.5vh;
            min-height: 91px;
            min-width: 91px;
            margin: -0.5vh 0px;

            background: rgba(0,0,0,0);
            border-radius: 50%;
            border: 0.2vh solid #444;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .circular-health > img {
            border-radius: 50%;
            border: 0.3vh solid #444;
            height: 11vh;
            min-height: 80px;
        }

        button {
            width:4vh;height:4vh;
            min-height:29px;min-width:29px;
            text-align:center;
            padding: 0px;
            margin:0px;
            border-width: 1px;
            background-color: #333;
            cursor:default;
        }

        button:hover {
            cursor:default;
            background-color: #444;
        }

        button:active {
            cursor:default;
            background-color: #555;
        }

        button > img {
            height: 3vh;
            min-height:22px;
        }

        #target {
            top: 1vh;
        }

        #target > .top {
            width: fit-content;
            position: relative;

            bottom: -1vh;
            height: 6vh;

            color: #ddd;

            display: flex;
            align-items: center;
            justify-content: center;
        }

        #target img {
            position: absolute;
            height: 4vh;
            left: -5vh;
            border-radius: 50%;
            border: 0.1vh solid #444;
        }

        #target-health {
            position: relative;

            min-width: 25vh;
            width: 150%;
            left: -25%;
            
            height: 1.5vh;
            bottom: 0px;
            background-color: #b44;
            border-radius: 1vh;
            border: 0.1vh solid #444;
        }





    </style>
    <script>

        //=====================================================================================================
        // Helper functions
        //=====================================================================================================

        function getColor(value) {

            // Ensure value is within the range 0 to 100
            value = Number(value)
            value = Math.max(0, Math.min(100, value));

            // Calculate the proportion for interpolation
            let red, green;

            if (value >= 50) {
                // From yellow (50) to green (100)
                green = 255;
                red = Math.round(255 * (1 - (value - 50) / 50));
            } else {
                // From red (0) to yellow (50)
                red = 255;
                green = Math.round(255 * (value / 50));
            }

            // Adjust color intensity based on toneFactor
            red = Math.round(red * 0.7);
            green = Math.round(green * 0.7);

            // Clamp the values to ensure they stay within 0-255
            red = Math.min(255, Math.max(0, red));
            green = Math.min(255, Math.max(0, green));

            // Return the color in RGB format
            //return `#ddd`
            return `rgba(`+red+`, `+green+`, `+80+`, 1)`;
        }

        //=====================================================================================================
        // Components
        //=====================================================================================================

        function target_character(name="", type="", image="", token_id="") {
            if (image != "") {
                image = `
                <img src="`+image+`"">
                `
            }

            return `
            <div id="target" token="`+token_id+`" class="center-horizontal">
                <div class="top center-horizontal">
                    `+image+`
                    <p>
                        <span style="font-size:120%; font-weight:bold">`+name+`</span><br>
                        <span style="color:#aaa">`+type+`</span>
                    </p>
                </div>
                <div id="target-health"></div>
            </div>
            `
        }

        function current_character() {
            return `
            <div id="health" class="circular-health">
                <img src="`+character_image+`">
            </div>`
        }

        function div(id = "", classes = "", children = "") {

        return `
        <div id="`+id+`" class="`+classes+`">
        `+children+`
        </div>
        `
        }

        function button(id="", image="") {

        return `
        <button id="`+id+`" style="">
            <img src="`+image+`">
        </button>
        `
        }

        //=====================================================================================================
        // Execution
        //=====================================================================================================

        function updateHealth() {
            const health_div = getId("health")

            toBackend(`
                var creature = new Creature("`+id+`");
                [creature.health, creature.max_health]
            `, (response)=>{ response = JSON.parse(response)

                health = Number(response[0])
                max_health = Number(response[1])
                hp_percent = health/max_health * 100

                start_hp = Number(hp_percent)
                end_hp = hp_percent != 0 ? Number(hp_percent) + 2 : 0;

                health_div.setAttribute("style", 
                    `background: linear-gradient(0deg, `+getColor(hp_percent)+` `+start_hp+`%, rgba(0,0,0,0) `+end_hp+`%);`
                )
            })
        }

        function updateTarget() {
            toBackend(`MapTool.tokens.getSelectedTokens()`, (response) => {
                selected_tokens = JSON.parse(response)

                if(selected_tokens.length == 1) {
                    token_id = selected_tokens[0]

                    if (token_id == "CD63A98070EB4D2792D8AAC3F9504EE4") {
                        if (getId("target")) { getId("target").remove()}
                        return
                    }

                    function createElement() {
                        toBackend(`var target = new Creature("`+token_id+`"); [target.name, target.type, target.race, target.portrait]`, (response)=>{
                            target = JSON.parse(response)

                            type = target[2] || target[1]

                            getId("content").innerHTML +=
                                target_character(target[0], type, target[3], token_id)
                            updatePageListeners()
                            updateHealth()
                        })
                    }

                    function updateHealth() {
                        toBackend(`var target = new Creature("`+token_id+`");[target.health, target.max_health]`, (response)=>{
                            target = JSON.parse(response)
                            health = Number(response[0])
                            max_health = Number(response[1])

                            start_hp = Number(hp_percent)
                            end_hp = hp_percent != 0 ? Number(hp_percent) + 2 : 0;

                            getId("target-health").setAttribute("style", 
                                `background: linear-gradient(90deg, #b44 `+start_hp+`%, rgba(0,0,0,0) `+end_hp+`%);`
                            )
                        })
                    }

                    if (!getId("target")) {
                        createElement()}
                    else if (getId("target").getAttribute("token") != token_id) {
                        if (getId("target")) { getId("target").remove()}
                        createElement()
                    } else {
                        updateHealth()
                    }
                } else {
                    if (getId("target")) { getId("target").remove()}
                }
            })
        }

        function loadPage() {
            if(character_image != "") {
                getId("content").innerHTML +=
                    div("character-menu", "menu bottom left", 
                        current_character() +
                        button("info","asset://3432c572c31826e72dedd81ef4a10c5b") +
                        button("inventory","asset://711c8f12938d7ef430fbcf7e2e5845ae") +
                        button("journal", "asset://4e98be9419bf1ce960319891b66add73") +
                        button("abilities", "asset://65479d57a2b1ffc116a12a5c731d91a7")
                    )
            }

            if (gm) {
                getId("content").innerHTML +=
                    div("master-menu", "menu bottom right", 
                        button("database", "asset://f218b6ad34fe8564e0553dc2bba91cc8")
                    )
            }

            updatePageListeners()
        }

        function updatePageListeners() {
            if(getId("info")){
                getId("info").addEventListener("click", ()=>{
                    openClosePage("", "Character", "creature_info.html")
                })
            }
            if (getId("database")) {
                getId("database").addEventListener("click", ()=>{
                    openClosePage("", "Database", "database.html")
                })
            }
        }

        function onWindowLoad() {
            loadPage()
            updateHealth(); setInterval(updateHealth, 200)
            updateTarget(); setInterval(updateTarget, 200)

        }



        //=====================================================================================================

        document.addEventListener("DOMContentLoaded", onWindowLoad)

    </script>
    ']
    </head>

    <body>

        
        <div id="content"></div>

    </body>

    }]