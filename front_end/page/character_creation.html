[h:id = arg(0)]

[dialog5("Character Creation", "width=800; height=800; temporary=1; input=1; noframe=0"), code: {
<head>
    <script>
        const id = "{id}"
    </script>

    <link rel="stylesheet" type="text/css" href="style.css@lib:front"></link>
    [r:scriptTag("open")][r:importScript("script.js@lib:front")][r:scriptTag("close")]

    [r:'
    <style>

    .outer { margin-top: 4vh }

    .score-container {
        display: grid;
        grid-template-columns: repeat(3, 85px);  /* Adjust to fit within 450px */
        gap: 0.5vh;
        grid-template-rows: repeat(2, 140px);
        width: fit-content; /* Set the width to 450px */
        margin: 0 auto; /* Automatically center horizontally */
        justify-items: center; /* Ensure items in the grid are centered horizontally */
        align-items: center; /* Ensure items in the grid are centered vertically */
    }

    .score {
        background-color: #333;
        width: 8.5vh;
        border: 0.2vh solid #444;
        border-radius: 0.5vh;
        padding: 1vh;
        padding-bottom: 0.8vh;
        text-align: center;
        height: 15vh;  /* Control the height for consistency */
    }

    .label {
        font-size: 100%; /* Smaller font size */
        font-weight: bold;
    }

    .score-value {
        font-size: 200%; /* Adjusted for a smaller look */
        font-weight: bold;
        width:fit-content;
        margin:auto;
        margin-top: 1vh;
        margin-bottom: 0;
        text-align:left;
    }

    .score-bonus {
        font-weight:700;
        width:fit-content;
        margin:auto;
        margin-top: 0;
        margin-bottom: 1vh;
        border: 0.2vh solid #999;
        border-radius: 10vh;
        padding: 0.3vh;
        padding-right: 0.4vh;
        font-size: 80%;
    }

    .increase, .decrease {
        padding: 0;
        width: 2vh;
        height: 2vh;
        min-height: unset;
        min-width: unset;
    }

    .page-turner {
        position:absolute; 
        margin:1vh; 
        font-size: 110%
    }

    </style>
    <script>

    //=====================================================================================================
    // Components
    //=====================================================================================================

    function div(id, content="", style="") {
        return `
        <div id="`+id+`" style="`+style+`">
            `+content+`
        </div>
        `
    }

    function title(title = "") {
        return `
        <h4>`+title+`</h4>
        `
    }

    function input(id = "", title = "", placeholder = "", style = "") {
        return `
        <h4 id="`+id+`-title">`+title+`</h4>
        <input style="`+style+`" id="`+id+`" placeholder="`+placeholder+`"></input>
        `
    }

    function select(id = "", title = "", options = [], placeholder="", style = "") {
        options_string = ""
        for (const value of options) {
            options_string += `<option value="`+value+`">`+capitalize(value)+`</option>`
        }
        return `
        <h4 id="`+id+`-title">`+title+`</h4>
        <select required style="`+style+`" id="`+id+`">
            <option disabled selected value="" hidden>`+placeholder+`</option>
            `+options_string+`
        </select>
        `
    }

    function inline_select(id = "", options = [], placeholder="", style = "") {
        options_string = ""
        for (const value of options) {
            options_string += `<option value=`+value+`>`+capitalize(value)+`</option>`
        }
        return `
        <select required style="`+style+`" id="`+id+`">
            <option value="" disabled selected hidden>`+placeholder+`</option>
            `+options_string+`
        </select>
        `
    }

    function checkbox(id = "", title = "", min_width = "40") {
        if (id == "" && title == "") {
            style = `style="display:none"`
        } else {style = ""}

        return `
        <div class="checkbox-container">
            <span class="checkbox-text" style="min-width: `+min_width+`px;">`+title+`</span>
            <div class="checkbox" id="`+id+`" `+style+` data-checked="`+"false"+`"></div>
        </div>
        `
    }

    function checkbox_grid(checkboxes = [["","Title"]], rows="3", min_width="40") {
        let checkboxes_string = ""
        for (const box of checkboxes) {
            checkboxes_string += checkbox(box[0], box[1], min_width)
        }

        return `
        <div class="checkbox-grid" style = "grid-template-columns: repeat(`+rows+`, 1fr)">
            `+checkboxes_string+`
        </div>
        `
    }

    function text_area(id = "", title = "", size = "7") {
        return `
        <h4>`+title+`</h4>
        <textarea id="`+id+`" rows="`+size+`" cols="30"></textarea>
        `
    }

    function container(title="", children="", id="", style="") {

        return `
        <div id="`+id+`" class="container center-horizontal" style="`+style+`">
            <h3 class="container-title">`+title+`</h3>
            <div id="`+id+`-content">`+children+`</div>
        </div>
        `
    }

    function button(id="", label="", classes="", style="") {
        return `
        <button id=`+id+` class="`+classes+`" style="`+style+`">`+label+`</button>
        `
    }

    function pointBuyCalculator() {
        const scores_list = ["strength", "dexterity", "constitution", "wisdom", "intelligence", "charisma"]
        content = ""
        
        for (const score of scores_list) {
            content += `
            <div class="score">
                <div class="label">`+capitalize(score)+`</div>
                <div class="score-value" id="`+score+`">10</div>
                <div class="score-bonus" id="bonus_`+score+`">0</div>
                <button class="decrease" id="reduce_`+score+`">-</button>
                <button class="increase" id="increase_`+score+`">+</button>
            </div>
            `
        }

        return `
        <h4>Available Points: <span id="points"></span> / 27</h4>
        <div class="spacer"></div>
        <div class="score-container">
            `+content+`
        </div>
        `
    }



    //=====================================================================================================
    // Helper functions
    //=====================================================================================================

    function addTabFunctionality(tab_list) {

        tab_list.forEach((tab_name) => {
            getId(tab_name+"-switch").addEventListener("click", () => {
                tab_list.forEach((value) => {
                    let button = getId(value+"-switch")
                    let div = getId(value+"-tab")
                    if (tab_name == value) {
                        button.setAttribute("class", "tab-switch active")
                        div.setAttribute("style", "")
                    } else {
                        button.setAttribute("class", "tab-switch")
                        div.setAttribute("style", "display:none")
                    }
                })
            })
        })

    }

    function addPointBuyFunctionality() {

        const ability_score_list = [
            getId("strength"), getId("dexterity"), getId("constitution"),
            getId("wisdom"), getId("intelligence"), getId("charisma")
        ]

        function updateAttributeBonus() {
            ability_score_list.forEach((ability_score) => {
                let attribute_bonus = getId("bonus_" + ability_score.id)

                attribute_bonus.innerHTML = Math.abs(Math.floor((Number(ability_score.innerHTML)-10)/2))
                if(Number(ability_score.innerHTML) >= 10) {
                    attribute_bonus.innerHTML = "+ " + attribute_bonus.innerHTML
                }
                else if(Number(ability_score.innerHTML) < 10) {
                    attribute_bonus.innerHTML = "- " + attribute_bonus.innerHTML
                }
            })
        }

        function availablePoints() {
            let total_points = 27
            
            ability_score_list.forEach((ability_score) => {
                let value = 0
                value = ability_score.getAttribute("value")

                let additional_cost = Math.max(value - 13, 0)
                let cost = Math.max(value - 8, 0)

                total_points = total_points - cost - additional_cost
            })

            return total_points 
        }

        function updatePoints() {
            getId("points").innerHTML = availablePoints()
        }

        // Add ability score value to scores, and behavior to increase/decrease buttons
        ability_score_list.forEach((ability_score) => {
            ability_score.setAttribute("value", ability_score.innerHTML)
            let decrease_button = getId("reduce_" + ability_score.id)
            let increase_button = getId("increase_" + ability_score.id)
            
            decrease_button.addEventListener("click", () => {
                let value = Number(ability_score.getAttribute("value"))

                if (value > 8) {
                    ability_score.setAttribute("value", value - 1)
                    ability_score.innerHTML = Number(ability_score.innerHTML) - 1
                }

                updateAttributeBonus()
                updatePoints()
            })
            increase_button.addEventListener("click", () => {
                let value = Number(ability_score.getAttribute("value"))

                if (value < 15) {
                    let cost = 0
                    if (value >= 13) {cost = 2}
                    else {cost = 1}

                    if (availablePoints() - cost < 0) {return}

                    ability_score.setAttribute("value", value + 1)
                    ability_score.innerHTML = Number(ability_score.innerHTML) + 1
                }

                updateAttributeBonus()
                updatePoints()
            })
        })

        updateAttributeBonus()
        updatePoints()
    }

    function getRaceInformation() {

        const scores_list = ["strength", "dexterity", "constitution", "wisdom", "intelligence", "charisma"]

        function race_description(race_description) {
            return `
            <pre style="
                white-space: pre-wrap; word-wrap: break-word; font-family:inherit; text-align:left;
                overflow-y:scroll; overflow-x:hidden; max-height:45vh; font-style:italic;
            ">`+race_description+`</pre>`
        }
        function race_features(race_features, database_features) {
            content = ""
            for (const name of race_features) {
                if(database_features[name]) {
                    content += `
                    <p style="text-align:left">
                        <b>`+name+`:</b> `+database_features[name].description+`
                    </p>`
                }
            }

            return content
        }
        function race_proficiencies(race_proficiencies, database_proficiencies) {
            content = ""
            level_names = {
                "0":"Proficiency",
                "1":"Expertise"
            }

            for (const item of race_proficiencies) {
                name = item["name"]
                level = item["level"]
                proficiency = database_proficiencies[name]
                if (proficiency) {
                    content += `<p style=text-align:left>
                        <b>`+name+` `+level_names[level]+`:</b> `+proficiency.description[0]
                    if(level == "1") {content += ` `+proficiency.description[1]}
                    content += `</p>`
                }
            }

            return content
        }
        function race_ability_scores(scores) {
            content = `<p>`
            first = true
            created = 0
            for (const i in scores_list) {
                const value = scores_list[i]

                if (scores[value] != 0) {
                    if (first) { first = false } else { content += `, `} // insert comma before element if not first
                    if (created == 3) { content += `<br>`} // if printed 3 skip line

                    content += `<b>`+capitalize(value)+`:</b> ` // title

                    if (Number(scores[value]) > 0) { content += "+" } // plus if positive

                    content += scores[value] // value

                    created += 1 // counter
                }
            }

            return content + `</p>`
        }

        toBackend(` [ 
            database.get_race("`+getId("race").value+`"),
            database.features.data,
            database.proficiencies.data,
        ]`, (response) => { response = JSON.parse(response)
            
            race = response[0]
            database_features = response[1]
            database_proficiencies = response[2]

            new_hash = hash(JSON.stringify(race))
            old_hash = getId("race-description").getAttribute("hash")
            if (new_hash == old_hash) { return }

            for (const score of scores_list) {
                value = getId(score).getAttribute("value")

                if(value){
                    value = Number(value)
                    racial_bonus = Number(race.ability_scores[getId(score).getAttribute("id")])

                    getId(score).innerHTML = value + racial_bonus
                }
            }

            getId("race-description").setAttribute("hash", new_hash)

            getId("race-description-content").innerHTML = race_description(race.description)
            getId("race-ability-scores-content").innerHTML = race_ability_scores(race.ability_scores)
            getId("race-features-content").innerHTML = race_features(race.features, database_features)
            getId("race-proficiencies-content").innerHTML = race_proficiencies(race.proficiencies, database_proficiencies)
        })

    }

    function submit() {

        // Get values from form
        let name = getId("name");
        let type = "humanoid";
        let race = getId("race");

        // Get attribute values from form
        let str = getId("strength");
        let dex = getId("dexterity");
        let con = getId("constitution");
        let wis = getId("wisdom");
        let int = getId("intelligence");
        let cha = getId("charisma");

        // Check if form is valid
        let valid = true
        if (name.value == "") {valid = false}
        if (race.value == "") {valid = false}
        if (valid == false) {return}

        // Send data to backend
        toBackend(`
            var creature = new Creature("`+id+`", true);
            creature.create(
                "`+name.value+`",
                "`+type.value+`",
                "`+race.value+`",
                "`+str.getAttribute("value")+`",
                "`+dex.getAttribute("value")+`",
                "`+con.getAttribute("value")+`",
                "`+wis.getAttribute("value")+`",
                "`+int.getAttribute("value")+`",
                "`+cha.getAttribute("value")+`",
            )
        `)

        closePage("Character Creation")

    }


    //=====================================================================================================
    // Execution
    //=====================================================================================================

    function raceTab() {

        getId("race-tab").innerHTML += (
            // Left portion of tab
            div("race-tab-left", (

                container("Basic", (
                    input("name", "Name", "Creature name") +
                    select("race", "Race", [], "Humanoid Race")
                )) +

                container("Description", "<p>Choose a race to see its description.</p>", "race-description", "") +
                container("Attribute Scores", "<p>Choose a race to see its bonuses to ability scores.</p>", "race-ability-scores", "")

            ), "position:absolute; left:0; width:50%") +

            // Right portion of tab
            div("race-tab-right", (

                container("Features", "<p>Choose a race to see its features.</p>", "race-features", "") +
                container("Proficiencies", "<p>Choose a race to see its Proficiencies.</p>", "race-proficiencies", "")

            ), "position:absolute;right:0; width:50%") +

            // Bottom buttons
            button("race-tab-next-page", "Next", "bottom right page-turner", "")
        )

        // Add button onclick
        getId("race-tab-next-page").addEventListener("click", ()=>{ getId("class-switch").click() })
        
        // Update character name
        toBackend(`MapTool.tokens.getTokenByID("`+id+`").getName()`,(response)=>{ getId("name").value = response })

        // Update races selector with backend races
        toBackend(`database.get_races_list()`, (response)=>{
            races = JSON.parse(response)
            options_string = ""
            for (const value of races) {
                options_string += `<option value="`+value+`">`+capitalize(value)+`</option>`
            }
            getId("race").innerHTML += options_string
        })
    }

    function classTab() {
        getId("class-tab").innerHTML +=
            button("class-tab-previous-page", "Previous", "bottom left page-turner", "") +
            button("class-tab-next-page", "Previous", "bottom right page-turner", "")
        
        // Tab Buttons
        getId("class-tab-previous-page").addEventListener("click", ()=>{ getId("race-switch").click() })
        getId("class-tab-next-page").addEventListener("click", ()=>{ getId("attributes-switch").click() })
    }

    function attributesTab() {
        // Attributes tab
        getId("attributes-tab").innerHTML +=
            container("Attributes",
                    pointBuyCalculator()
            ) +
            button("attributes-tab-previous-page", "Previous", "bottom left page-turner", "")

        // Tab buttons
        getId("attributes-tab-previous-page").addEventListener("click", ()=>{ getId("class-switch").click() })

        addPointBuyFunctionality()
    }

    function onWindowLoad() {

        addTabFunctionality(["race","class","attributes"])

        // Race
        raceTab()

        // Class
        classTab()

        // Attributes
        attributesTab() 

        getRaceInformation(); setInterval(getRaceInformation, 200) // Requires attributes

    }



    //=====================================================================================================

    document.addEventListener("DOMContentLoaded", onWindowLoad)

    </script>
    ']
</head>

<body>

    <div class="tab-switch-div">
        <button class="tab-switch active" id="race-switch">Race</button>
        <button class="tab-switch" id="class-switch">Class</button>
        <button class="tab-switch" id="attributes-switch">Attributes</button>
    </div>
    <div class="outer" id="race-tab"></div>
    <div class="outer" id="class-tab" style="display:none"></div>
    <div class="outer" id="attributes-tab" style="display:none"></div>

</body>

}]