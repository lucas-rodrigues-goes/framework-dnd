    [h,if(!argCount()>0):id = arg(0); id = getImpersonated()]
    [h,if(id==""):id = getImpersonated()]

    [dialog5("Character Creation", "width=800; height=800; temporary=1; input=1; noframe=0"), code: {
    <head>
        <script>
            const id = "{id}"
        </script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" type="text/css" href="style.css@lib:front"></link>
        [r:scriptTag("open")][r:importScript("script.js@lib:front")][r:scriptTag("close")]
        [r:scriptTag("open")][r:importScript("components.js@lib:front")][r:scriptTag("close")]

        [r:'
        <style>

        .outer { margin-top: 4vh }

        .page-turner {
            position:absolute; 
            margin:1vh; 
            font-size: 110%
        }

        </style>
        <script>

        //=====================================================================================================
        // Helper functions
        //=====================================================================================================

        function addTabFunctionality(tab_list) {

            tab_list.forEach((tab_name) => {
                getId(tab_name+"-switch").addEventListener("click", () => {
                    tab_list.forEach((value) => {
                        let button = getId(value+"-switch")
                        let div = getId(value+"-tab")
                        if (tab_name == value) {
                            button.setAttribute("class", "tab-switch active")
                            div.setAttribute("style", "")
                        } else {
                            button.setAttribute("class", "tab-switch")
                            div.setAttribute("style", "display:none")
                        }
                    })
                })
            })

        }

        function addPointBuyFunctionality() {

            const ability_score_list = [
                getId("strength"), getId("dexterity"), getId("constitution"),
                getId("wisdom"), getId("intelligence"), getId("charisma")
            ]

            function updateAttributeBonus() {
                ability_score_list.forEach((ability_score) => {
                    let attribute_bonus = getId("bonus_" + ability_score.id)

                    attribute_bonus.innerHTML = Math.abs(Math.floor((Number(ability_score.innerHTML)-10)/2))
                    if(Number(ability_score.innerHTML) >= 10) {
                        attribute_bonus.innerHTML = "+ " + attribute_bonus.innerHTML
                    }
                    else if(Number(ability_score.innerHTML) < 10) {
                        attribute_bonus.innerHTML = "- " + attribute_bonus.innerHTML
                    }
                })
            }

            function availablePoints() {
                let total_points = 27
                
                ability_score_list.forEach((ability_score) => {
                    let value = 0
                    value = ability_score.getAttribute("value")

                    let additional_cost = Math.max(value - 13, 0)
                    let cost = Math.max(value - 8, 0)

                    total_points = total_points - cost - additional_cost
                })

                return total_points 
            }

            function updatePoints() {
                getId("points").innerHTML = availablePoints()
            }

            // Add ability score value to scores, and behavior to increase/decrease buttons
            ability_score_list.forEach((ability_score) => {
                ability_score.setAttribute("value", ability_score.innerHTML)
                let decrease_button = getId("reduce_" + ability_score.id)
                let increase_button = getId("increase_" + ability_score.id)
                
                decrease_button.addEventListener("click", () => {
                    let value = Number(ability_score.getAttribute("value"))

                    if (value > 8) {
                        ability_score.setAttribute("value", value - 1)
                        ability_score.innerHTML = Number(ability_score.innerHTML) - 1
                    }

                    updateAttributeBonus()
                    updatePoints()
                })
                increase_button.addEventListener("click", () => {
                    let value = Number(ability_score.getAttribute("value"))

                    if (value < 15) {
                        let cost = 0
                        if (value >= 13) {cost = 2}
                        else {cost = 1}

                        if (availablePoints() - cost < 0) {return}

                        ability_score.setAttribute("value", value + 1)
                        ability_score.innerHTML = Number(ability_score.innerHTML) + 1
                    }

                    updateAttributeBonus()
                    updatePoints()
                })
            })

            updateAttributeBonus()
            updatePoints()
        }

        function getRaceInformation() {

            const scores_list = ["strength", "dexterity", "constitution", "wisdom", "intelligence", "charisma"]

            function race_description(race_description) {
                return `
                <pre style="
                    white-space: pre-wrap; word-wrap: break-word; font-family:inherit; text-align:left;
                ">`+race_description+`</pre>`
            }
            function race_features(race_features, database_features) {
                content = ""
                for (const name of race_features) {
                    if(database_features[name]) {
                        content += `
                        <p style="text-align:left">
                            <b>`+name+`:</b> `+database_features[name].description+`
                        </p>`
                    }
                }

                return content
            }
            function race_proficiencies(race_proficiencies, database_proficiencies) {
                content = ""
                level_names = {
                    "0":"Proficiency",
                    "1":"Expertise"
                }

                for (const item of race_proficiencies) {
                    name = item["name"]
                    level = item["level"]

                    proficiency = database_proficiencies[name]

                    if (proficiency) {
                        type = database_proficiencies[name].type
                        title = type == "language" ? "Language" : level_names[level]

                        content += `<p style=text-align:left>
                            <b>`+name+` `+title+`:</b> `+proficiency.description[0]
                        if(level == "1") {content += ` `+proficiency.description[1]}
                        content += `</p>`
                    }
                }

                return content
            }
            function race_ability_scores(scores) {
                content = `<p>`
                first = true
                created = 0
                for (const i in scores_list) {
                    const value = scores_list[i]

                    if (scores[value] != 0) {
                        if (first) { first = false } else { content += `, `} // insert comma before element if not first
                        if (created == 3) { content += `<br>`} // if printed 3 skip line

                        content += `<b>`+capitalize(value)+`:</b> ` // title

                        if (Number(scores[value]) > 0) { content += "+" } // plus if positive

                        content += scores[value] // value

                        created += 1 // counter
                    }
                }

                return content + `</p>`
            }
            
            toBackend(` [ 
                database.get_race("`+getId("race").value+`"),
                database.features.data,
                database.proficiencies.data,
            ]`, (response) => { response = JSON.parse(response)
                
                race = response[0]
                database_features = response[1]
                database_proficiencies = response[2]

                new_hash = hash(JSON.stringify(response))
                old_hash = getId("race-tab").getAttribute("hash")
                if (new_hash == old_hash) { return }

                for (const score of scores_list) {
                    value = getId(score).getAttribute("value")

                    if(value){
                        value = Number(value)
                        racial_bonus = Number(race.ability_scores[getId(score).getAttribute("id")])

                        getId(score).innerHTML = value + racial_bonus
                    }
                }

                getId("race-tab").setAttribute("hash", new_hash)

                getId("race-description-content").innerHTML = race_description(race.description)
                getId("race-ability-scores-content").innerHTML = race_ability_scores(race.ability_scores)
                getId("attributes-race-ability-scores-content").innerHTML = race_ability_scores(race.ability_scores)
                getId("race-features-content").innerHTML = race_features(race.features, database_features)
                getId("race-proficiencies-content").innerHTML = race_proficiencies(race.proficiencies, database_proficiencies)
            })

        }

        function submit() {

            // Get values from form
            let name = getId("name").value;
            let type = "Humanoid";
            let race = getId("race").value;

            // Get attribute values from form
            let str = getId("strength").getAttribute("value");
            let dex = getId("dexterity").getAttribute("value");
            let con = getId("constitution").getAttribute("value");
            let wis = getId("wisdom").getAttribute("value");
            let int = getId("intelligence").getAttribute("value");
            let cha = getId("charisma").getAttribute("value");

            // Send data to backend
            toBackend(`
                var creature = new Creature(getImpersonated(), true);
                creature.create(
                    "`+name+`",
                    "`+type+`",
                    "`+race+`",

                    `+str+`,
                    `+dex+`,
                    `+con+`,
                    `+wis+`,
                    `+int+`,
                    `+cha+`,
                )
            `.trim())

            closePage("Character Creation")

        }


        //=====================================================================================================
        // Execution
        //=====================================================================================================

        function raceTab() {

            getId("race-tab").innerHTML += (
                // Left portion of tab
                div({id:"race-tab-left", style:"position:absolute; left:0; width:50%", content:(
                    container({title:"Basic", content:(
                        input({id:"name", placeholder:"Name"}) +
                        select({id:"race", placeholder:"Race", required:true, content:[]})
                    )})+
                    container({title:"Description", id:"race-description", max_height:40, content:(
                        element({tag:"p", content:"Choose a race to see its description."})
                    )}) +
                    container({title:"Attribute Scores", id:"race-ability-scores", content:(
                        element({tag:"p", content:"Choose a race to see its bonuses to ability scores."}) 
                    )})
                )}) +
                div({id:"race-tab-right", style:"position:absolute; right:0; width:50%", content:(
                    container({title:"Features", id:"race-features", content:(
                        element({tag:"p", content:"Choose a race to see its features."})
                    )}) +
                    container({title:"Proficiencies", id:"race-proficiencies", content:(
                        element({tag:"p", content:"Choose a race to see its Proficiencies."}) 
                    )})
                )}) +
                button({id:"race-tab-next-page", content:"Next", classes:"bottom right page-turner"})
            )

            // Add button onclick
            getId("race-tab-next-page").addEventListener("click", ()=>{ getId("class-switch").click() })
            
            // Update character name
            toBackend(`MapTool.tokens.getTokenByID("`+id+`").getName()`,(response)=>{ getId("name").value = response })

            // Update races selector with backend races
            toBackend(`database.get_races_list()`, (response)=>{
                races = JSON.parse(response)

                getId("race").innerHTML += options_from_array(races).trim()
            })
        }

        function classTab() {

            getId("class-tab").innerHTML +=
                button({id:"class-tab-previous-page", content: "Previous", classes:"bottom left page-turner"}) +
                button({id:"class-tab-next-page", content:"Next", classes: "bottom right page-turner"})
            
            // Tab Buttons
            getId("class-tab-previous-page").addEventListener("click", ()=>{ getId("race-switch").click() })
            getId("class-tab-next-page").addEventListener("click", ()=>{ getId("attributes-switch").click() })
        }

        function attributesTab() {

            getId("attributes-tab").innerHTML += (
                div({id:"attributes-tab-left", style:"position:absolute; left:0; width:50%", content:(
                    container({title:"Attributes", content:(
                        pointBuyCalculator()
                    )}) +
                    container({title:"Race Bonus", id:"attributes-race-ability-scores", content:(
                        element({tag:"p", content:"Choose a race to receive bonuses to ability scores."}) 
                    )})
                )}) +
                div({id:"attributes-tab-right", style:"position:absolute; left:0; width:50%", content:(
                    ""
                )}) +
                button({id:"attributes-tab-previous-page", content:"Previous", classes: "bottom left page-turner"}) +
                button({id:"submit", content:"Finish", classes: "bottom right page-turner"})
            )

            // Tab buttons
            getId("attributes-tab-previous-page").addEventListener("click", ()=>{ getId("class-switch").click() })
            getId("submit").addEventListener("click", ()=>{ submit() })

            loadPointBuyCalculator()
        }

        function onWindowLoad() {

            addTabFunctionality(["race","class","attributes"])

            // Race
            raceTab()

            // Class
            classTab()

            // Attributes
            attributesTab() 

            getRaceInformation(); setInterval(getRaceInformation, 200) // Requires attributes

        }



        //=====================================================================================================

        document.addEventListener("DOMContentLoaded", onWindowLoad)

        </script>
        ']
    </head>

    <body>

        <div class="tab-switch-div">
            <button class="tab-switch active" id="race-switch">Race</button>
            <button class="tab-switch" id="class-switch">Class</button>
            <button class="tab-switch" id="attributes-switch">Attributes</button>
        </div>
        <div class="outer" id="race-tab"></div>
        <div class="outer" id="class-tab" style="display:none"></div>
        <div class="outer" id="attributes-tab" style="display:none"></div>

    </body>

    }]