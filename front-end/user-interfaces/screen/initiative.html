[overlay("Initiative"), code: {
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" type="text/css" href="style.css@lib:front"></link>
        [r:scriptTag("open")][r:importScript("style.js@lib:front")][r:scriptTag("close")]
        [r:scriptTag("open")][r:importScript("script.js@lib:front")][r:scriptTag("close")]
        [r:scriptTag("open")][r:importScript("components_new.js@lib:front")][r:scriptTag("close")]
        [r:scriptTag("open")][r:importScript("data_description.js@lib:front")][r:scriptTag("close")]
    
        [r:'
        <style>
    
        /*===================================================================================================*/
        /* Document */
        /*===================================================================================================*/
    
        body {
            all:unset;
            font-size: 1.7vh;
            color: #ddd;
        }

        img {filter: none}
    
        .left, .right, .bottom, .top, .center-horizontal {position:fixed;}
    
        .menu {
            position: fixed;
    
            padding: 1vh;
            margin: 0.5vh;
    
            display: flex;
            align-items: end;
            gap: 1vh;
        }

        .hidden { display: none !important }
    
        .block {
            --pointermap: block
        }
    
        /*===================================================================================================*/
        /* Button */
        /*===================================================================================================*/
    
        .button-background {
            background-color: #333;
            border: 0.2vh solid #444;
            border-radius: 1vh;
            padding: 0.3vh;
            padding-left: 0.4vh;
            display:flex;
    
            background-color: rgba(0,0,0,0);
            border: none;
        }
    
        .button-background img {
            background-color: #292929;
            border: 0.3vh solid #444;
            border-radius: 0.5vh;
            display:block;
            height: 3vh;
            padding: 0.5vh;
            margin: 0 0.25vh;
            min-height:29px;
        }
    
        .button-background img:hover {
            background-color: #444;
            border: 0.3vh solid #555;
            opacity:1;
        }
        .button-background img:active {
            background-color: #555;
            opacity:1;
        }

        button {
            box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.3);
            background-color: #292929;
            border: 0.2vh solid #666;
            color: #fff;
            border-radius: 0.5vh;
            padding: 0.5vh;
            margin-top: 1.5vh;
            width: 95%;
            opacity: 0.9;
        }
        button:hover {
            background-color: #444;
            border-color: #555; 
            cursor: default;
        }
        button:active {
            background-color: #555;
        }    
    
        /*===================================================================================================*/
    
        </style>
        <script>
        
        const isGM = '+isGM()+' == 1

        const portraitClick = (id) => {
                const creature = id ? `instance("`+id+`");` : `impersonated();`
                backend(`{
                    const creature = `+creature+`;
                    const imp_creature = impersonated();
                    const sel_creature = selected();

                    const ownsCreature = creature.owners.includes(player) || `+isGM+`;
                    const impersonatesCreature = imp_creature ? imp_creature.id == creature.id : false;
                    const canSeeCreature = imp_creature ? imp_creature.target_visibility(creature) > 0 : false;
                    const selectsCreature = sel_creature ? sel_creature.id == creature.id : false;

                    if (ownsCreature && !impersonatesCreature) {
                        creature.impersonate();
                    } else {
                        if (selectsCreature && canSeeCreature) {
                            creature.go_to()
                        } else if (!selectsCreature && canSeeCreature) {
                            creature.select()
                        }
                    }
                }`)
            }

        //-----------------------------------------------------------------------------------------------------
        // Update Elements
        //-----------------------------------------------------------------------------------------------------

        function updateEndTurnButton ({visible=false}) {
            // End Turn Button
            document.getElementById("end-turn").classList[visible ? "remove" : "add"]("hidden")
        }

        function updateInitiativeCreatures ( { creatures=[] }={} ) {
            // Initiative Creatures
            const elem = document.getElementById("initiative-creatures")
            elem.clearChildren()
            for (const creature of creatures) {
                elem.appendChild(
                    InitiativeCreature(creature)
                )
            }
        }

        //-----------------------------------------------------------------------------------------------------
        // Components
        //-----------------------------------------------------------------------------------------------------

        function InitiativeCreature ({ id, attitude, player, portrait, name, status, description, initiative=0 }) {
            const isPlaying = status == "Playing"

            // Border color
            let color; {
                if (description == "Spellcasting") color = "#66f"
                else color = colors.healthbar[attitude]
            }

            // Events
            const click = () => portraitClick(id)
            function mousedown (event) {
                // Right Click
                if (event.button != 2) return
                const buttons = {}
                
                // Restart Turn
                if (isGM && isPlaying) buttons["Restart Turn"] = () => backend(`Initiative.next_creature()`)

                // Run context menu
                context_menu({event: event, buttons: buttons})
            }
            function mouseover (event) {
                this.parentElement.style.borderColor = "#ddd"
                this.parentElement.nextElementSibling.style.borderColor = "#ddd"
            }
            function mouseout (event) {
                this.parentElement.style.borderColor = color
                this.parentElement.nextElementSibling.style.borderColor = color
            }

            // Element
            return element ({tag: "div", 
                style: {
                    transform: isPlaying && "scale(1.2) translateX(-0.5vh) translateY(0.5vh)", 
                    position: "relative", 
                    height: "9.5vh", 
                    opacity: initiative >= 12 ? 1 : 1,
                },
                children: [
                    {tag: "div", style: {border: "0.3vh solid " + color, width: "5.5vh", height: "7vh", borderRadius: "1vh", overflow: "hidden", boxShadow: "0 0.5vh 1vh rgba(0,0,0,0.3)"}, children: [
                        {tag: "img", 
                            style: {height: "102%", width: "102%", objectPosition: "center", objectFit: "cover", backgroundColor: "#222",},
                            attributes: {src: portrait},
                            events: { click, mousedown, mouseover, mouseout }
                        },
                    ]},
                    {tag: "div", attributes: {class: "center-horizontal"}, 
                        style: {
                            position: "absolute", bottom: "-0.5vh", 
                            backgroundColor: "#232323", borderRadius: "1.5vh", 
                            height: "2.5vh", width: "2.5vh", display: "flex", alignItems: "center", justifyContent: "center",
                            fontWeight: "bold", fontSize: "85%", border: "0.3vh solid " + color, boxShadow: "0 0.5vh 1vh rgba(0,0,0,0.3)"
                        },
                        children: [
                            {tag: "span", text: initiative}
                        ]
                    }
                ]
            })
        }

        function InitiativeCreatures() {

            // Element
            return element (
                {tag: "div",
                    attributes: {id: "initiative-creatures"},
                    style: {marginTop: "1.5vh", display: "flex", gap: "1vh", justifyContent: "center"}
                }
            )
        }

        function InitiativeControls () {

            // Element
            return element({tag: "div",
                attributes: {id: "initiative-controls"}, 
                style: {marginTop: "-1vh", marginBottom: "3vh", gap: "0.1vh", display: "flex", justifyContent: "center"}, 
                children: [
                    // Add creatures
                    {tag: "button", 
                        attributes: {class: "tooltip-bottom", tooltip: "Add Creatures to Initiative"},
                        style: {borderRadius: "2vh", width: "2vh", height: "2vh", display: '+isGM()+' == 1 ? "flex" : "none"}, 
                        events: { click: () => backend(`Initiative.add_creatures()`) },
                        children: [
                            {tag: "img", style: {height: "100%", width: "100%"}, attributes: {src: "asset://5282add24bd7663d499861e313980245"}}
                        ]
                    },

                    // End turn
                    {tag: "button", 
                        attributes: {class: "hidden", id: "end-turn", tooltip: "End turn"},
                        style: {borderRadius: "2vh", width: "8vh", height: "2vh", display: "flex", justifyContent: "center", alignItems: "center"}, 
                        events: { click: () => backend(`Initiative.end_turn(instance(Initiative.current_creature))`) },
                        children: ["End Turn"]
                    },

                    // Clear initiative
                    {tag: "button",
                        attributes: {class: "tooltip-bottom", tooltip: "Clear initiative"},
                        style: {borderRadius: "2vh", width: "2vh", height: "2vh", display: '+isGM()+' == 1 ? "flex" : "none"}, 
                        events: { click: () => backend(`Initiative.clear_initiative()`) },
                        children: [
                            {tag: "img", style: {height: "100%", width: "100%"}, attributes: {src: "asset://e984745ad793f4ca43bc3c5f14cb317d"}}
                        ]
                    }
                ]
            })
        }

        function Menu() {

            // Element
            return element(
                {tag: "div", attributes: {class: "center-horizontal"}, children: [
                    InitiativeCreatures(),
                    InitiativeControls(),
                ]}
            )
        }

        function Body ({ children=[] }={}) {
            return element({tag: "div", attributes: {id: "body", class: ""}, parent: document.body, children: children})
        }
    
        //-----------------------------------------------------------------------------------------------------
        // Execution
        //-----------------------------------------------------------------------------------------------------

        function Page () {
            // Elements
            Body({children: [
                Menu()
            ]})
        }

        window.onload = function () {
            try {
                Page()
            } catch (error) {
                console.log(error)
            }
        }
    
        //-----------------------------------------------------------------------------------------------------
    
        </script>
        ']
    </head>
    
    <body>
    
    </body>
    
    }]